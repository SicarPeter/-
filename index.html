<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <title>標車酷預約系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" rel="stylesheet" />
  <style>
    :root{
      --bg:#191935; --card:#1f1f3f; --text:#f0f0f0; --muted:#9aa0b4;
      --accent:#D9F107; --input:#2a2a47; --border:#3f3f61; --danger:#ff8c8c; --success:#8cff8c;
      --control-h: 48px; /* 所有欄位高度一致 */
      --radius: 10px;
    }
    html,body{height:100%}
    html{-webkit-text-size-adjust:100%}

    body{
      font-family:'Noto Sans TC',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol',sans-serif;
      background:var(--bg); color:var(--text); margin:0;
      display:flex; justify-content:center; /* 手機會改為置頂 */
      min-height:100svh;
      padding: max(16px, env(safe-area-inset-top) + 12px) 16px 24px;
    }
    .container{
      width:100%; max-width:720px; background:var(--card);
      border-radius:14px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    h1{margin:0 0 6px; font-size:clamp(22px,4.2vw,32px); color:var(--accent); text-align:center; font-weight:800;}
    .sub{margin:0 0 18px; text-align:center; color:var(--muted); font-size:14px}

    .grid{display:grid; gap:14px}
    .row{display:grid; gap:12px; grid-template-columns:1fr 1fr}
    .form-group{display:grid; gap:8px; min-width:0;} /* min-width:0 防溢出 */
    label{font-weight:700; font-size:14px}

    input,select,textarea,button{
      font:inherit; font-size:16px; /* iOS 防放大 */
      width:100%; box-sizing:border-box; border-radius:var(--radius);
      border:1px solid var(--border); background:var(--input); color:var(--text);
    }
    input,select{ height:var(--control-h); padding:0 14px; line-height:var(--control-h); }
    textarea{ padding:12px 14px; resize:vertical; }
    select{
      -webkit-appearance:none; -moz-appearance:none; appearance:none;
      background-image: linear-gradient(45deg,transparent 50%,#aaa 50%),
                        linear-gradient(135deg,#aaa 50%,transparent 50%),
                        linear-gradient(to right, transparent, transparent);
      background-position: right 12px center, right 6px center, right 32px center;
      background-size: 8px 8px, 8px 8px, 1px 100%;
      background-repeat: no-repeat;
    }
    input::placeholder, textarea::placeholder{color:#b8bed0}
    input:focus,select:focus,textarea:focus{
      outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(217,241,7,.25)
    }
    button{
      height:calc(var(--control-h) + 4px); padding:0 16px;
      background:var(--accent); color:#101020; border:none; font-weight:800; cursor:pointer;
    }
    button:disabled{opacity:.6; cursor:not-allowed}
    .help{color:var(--muted); font-size:12px}
    #status{display:none; margin-top:10px; font-weight:700; text-align:center}
    #status.success{display:block; color:var(--success)}
    #status.error{display:block; color:var(--danger)}

    @media (max-width:720px){
      body{ align-items:flex-start; } /* 手機置頂顯示，避免標題被頂掉 */
      .container{padding:18px}
      .row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>標車酷預約系統</h1>
    <p class="sub">定點檢測 · 台北市中山區濱江街 326-1 號</p>

    <form id="form" class="grid" novalidate>
      <div class="row">
        <div class="form-group">
          <label for="brand">廠牌</label>
          <select id="brand" required disabled>
            <option value="">載入中...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="series">車款</label>
          <select id="series" required disabled>
            <option value="">請先選擇廠牌</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="item">預約項目</label>
        <select id="item" name="item" required>
          <option value="車輛檢測">車輛檢測</option>
        </select>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="datepicker">日期</label>
          <input id="datepicker" name="date" type="text" inputmode="none" autocomplete="off" required>
          <div class="help">可約 2 個月內</div>
        </div>
        <div class="form-group">
          <label for="slot">時段</label>
          <select id="slot" name="time" required disabled>
            <option value="">請先選擇日期</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="name">姓名</label>
          <input id="name" name="name" type="text" placeholder="請輸入您的姓名" required>
        </div>
        <div class="form-group">
          <label for="phone">手機號碼</label>
          <input id="phone" name="phone" type="tel" inputmode="numeric" pattern="^(09|\\+?8869)\\d{8}$" placeholder="09xxxxxxxx" required>
        </div>
      </div>

      <div class="form-group">
        <label for="email">電子郵件</label>
        <input id="email" name="email" type="email" placeholder="example@gmail.com" required>
      </div>

      <div class="form-group">
        <label for="memo">備註（可輸入 LINE ID 或其他需求）</label>
        <textarea id="memo" name="memo" rows="3" placeholder="選填"></textarea>
      </div>

      <button id="submit" type="submit">立即預約</button>
      <div id="status"></div>
      <p class="help">送出即同意本服務使用條款。</p>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
  <script>
    /* ===== 你的後端設定 ===== */
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxKNqFkl3FqdskRQ_zUD3xvsfUPPuI5RT-5qDW242o3WedCHGNdNT3U-m6k8XT1nG8o/exec';
    const API_BASE        = 'https://api.sicar.com.tw'; // 你們工程師的 API

    /* ===== DOM ===== */
    const form      = document.getElementById('form');
    const dateEl    = document.getElementById('datepicker');
    const slotEl    = document.getElementById('slot');
    const statusEl  = document.getElementById('status');
    const submitBtn = document.getElementById('submit');
    const brandEl   = document.getElementById('brand');
    const seriesEl  = document.getElementById('series');

    /* ===== 日期選擇 ===== */
    const today = new Date();
    const max   = new Date(); max.setMonth(max.getMonth()+2);
    const picker = new Litepicker({
      element: dateEl,
      singleMode: true,
      lang: 'zh-TW',
      format: 'YYYY-MM-DD',
      minDate: today,
      maxDate: max,
      autoApply: true,
      mobileFriendly: true,
    });
    picker.on('selected', (date) => {
      const d = date ? date.format('YYYY-MM-DD') : '';
      if (d) fetchSlots(d);
    });

    /* ===== 進站先載品牌（直連失敗自動改走代理） ===== */
    initBrands();

    async function initBrands(){
      brandEl.disabled = true;
      brandEl.innerHTML = `<option value="">載入中...</option>`;
      seriesEl.disabled = true;
      seriesEl.innerHTML = `<option value="">請先選擇廠牌</option>`;

      try{
        const list = await fetchBrandsDirect();     // 先直連 https://api.sicar.com.tw
        fillBrands(list);
      }catch(err1){
        console.warn('[brands] direct failed:', err1?.message || err1);
        try{
          const list2 = await fetchBrandsViaProxy(); // 退回用 Apps Script 代理
          fillBrands(list2);
        }catch(err2){
          console.error('[brands] proxy failed:', err2?.message || err2);
          brandEl.innerHTML = `<option value="">品牌載入失敗</option>`;
          toast('品牌 API 連線失敗，請稍後再試。', 'error');
        }
      }
    }

    function fillBrands(list){
      brandEl.innerHTML = '';
      brandEl.appendChild(new Option('請選擇廠牌',''));
      list.forEach(b => brandEl.appendChild(new Option(b.name, b.id)));
      brandEl.disabled = false;
    }

    // 品牌改變 → 載入車款（同樣直連→代理兩段式）
    brandEl.addEventListener('change', async ()=>{
      const id = brandEl.value;
      seriesEl.disabled = true;
      seriesEl.innerHTML = `<option value="">載入中...</option>`;
      if(!id){ seriesEl.innerHTML = `<option value="">請先選擇廠牌</option>`; return; }

      try{
        const list = await fetchSeriesDirect(id);
        fillSeries(list);
      }catch(err1){
        console.warn('[series] direct failed:', err1?.message || err1);
        try{
          const list2 = await fetchSeriesViaProxy(id);
          fillSeries(list2);
        }catch(err2){
          console.error('[series] proxy failed:', err2?.message || err2);
          seriesEl.innerHTML = `<option value="">車款載入失敗</option>`;
          toast('車款 API 連線失敗，請稍後再試。', 'error');
        }
      }
    });

    function fillSeries(list){
      seriesEl.innerHTML = '';
      seriesEl.appendChild(new Option('請選擇車款',''));
      list.forEach(s => seriesEl.appendChild(new Option(s.name, s.id)));
      seriesEl.disabled = false;
    }

    /* ===== 呼叫工程師 API（直連） ===== */
    async function fetchBrandsDirect(){
      const res = await fetch(`${API_BASE}/api/v3/Yahoocar/get_brand`, { method:'GET', mode:'cors' });
      const data = await parseJson(res);
      return normalizeList(data);
    }
    async function fetchSeriesDirect(brandId){
      const res = await fetch(`${API_BASE}/api/v3/Yahoocar/get_series/${encodeURIComponent(brandId)}`, { method:'GET', mode:'cors' });
      const data = await parseJson(res);
      return normalizeList(data);
    }

    /* ===== 透過 Apps Script 代理（避免 CORS） =====
       後端需支援：
       GET ?action=brands                    -> [{id,name},...]
       GET ?action=series&brand_id=123       -> [{id,name},...]
    */
    async function fetchBrandsViaProxy(){
      const res = await fetch(`${APPS_SCRIPT_URL}?action=brands`, { method:'GET', mode:'cors' });
      const data = await parseJson(res);
      if (!data.success) throw new Error(data.message || 'proxy error');
      return normalizeList(data.data);
    }
    async function fetchSeriesViaProxy(brandId){
      const res = await fetch(`${APPS_SCRIPT_URL}?action=series&brand_id=${encodeURIComponent(brandId)}`, { method:'GET', mode:'cors' });
      const data = await parseJson(res);
      if (!data.success) throw new Error(data.message || 'proxy error');
      return normalizeList(data.data);
    }

    function normalizeList(raw){
      // 允許： [ {id,name}, ... ] 或 { data:[...] }
      const arr = Array.isArray(raw) ? raw : (Array.isArray(raw?.data) ? raw.data : []);
      return arr.map(x => ({ id: x.id, name: x.name })).filter(x => x.id != null && x.name);
    }

    async function parseJson(res){
      const txt = await res.text();
      try{ return JSON.parse(txt); }catch{ throw new Error(`非 JSON 回應: ${txt.slice(0,120)}`); }
    }

    /* ===== 可用時段 ===== */
    async function fetchSlots(dateStr) {
      setSelectLoading();
      try {
        const url = `${APPS_SCRIPT_URL}?action=slots&date=${encodeURIComponent(dateStr)}`;
        const res = await fetch(url, { method: 'GET', mode: 'cors' });
        const json = await parseJson(res);
        if (!json.success && !json.ok) throw new Error(json.message || '無法載入時段');

        const slots = (json.data || json.slots || {});
        const keys = Object.keys(slots).sort();
        slotEl.innerHTML = '';
        if (keys.length === 0) {
          slotEl.innerHTML = `<option value="">當日已無可預約時段</option>`;
          slotEl.disabled = true;
          return;
        }
        slotEl.disabled = false;
        slotEl.appendChild(new Option('請選擇時段',''));
        keys.forEach(k => {
          slotEl.appendChild(new Option(`${k}（剩餘 ${slots[k]} 位）`, k));
        });
      } catch (err) {
        slotEl.innerHTML = `<option value="">無法載入時段</option>`;
        slotEl.disabled = true;
        toast(err.message || '連線失敗', 'error');
      }
    }
    function setSelectLoading() {
      slotEl.disabled = true;
      slotEl.innerHTML = `<option value="">載入中...</option>`;
    }

    /* ===== 送出表單 ===== */
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const requiredIds = ['brand','series','item','datepicker','slot','name','phone','email'];
      for (const id of requiredIds) {
        const el = (id==='slot') ? slotEl : document.getElementById(id);
        if (!el || !el.value) {
          toast('請填寫所有必填欄位。', 'error');
          return;
        }
      }

      submitBtn.disabled = true;
      submitBtn.textContent = '提交中...';
      toast('', 'hide');

      try {
        const payload = {
          item:   document.getElementById('item').value,
          date:   dateEl.value,
          time:   slotEl.value,
          name:   document.getElementById('name').value,
          phone:  document.getElementById('phone').value,
          email:  document.getElementById('email').value,
          memo:   document.getElementById('memo').value || '',
          brand_id:  brandEl.value,
          brand_name: brandEl.options[brandEl.selectedIndex]?.text || '',
          series_id: seriesEl.value,
          series_name: seriesEl.options[seriesEl.selectedIndex]?.text || ''
        };

        const res  = await fetch(APPS_SCRIPT_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload),
          mode:'cors',
        });
        const json = await parseJson(res);

        if (json.success || json.ok) {
          toast((json.message || '預約成功！'), 'success');
          form.reset();
          slotEl.innerHTML = `<option value="">請先選擇日期</option>`;
          slotEl.disabled = true;
          await initBrands();
        } else {
          throw new Error(json.message || '預約失敗');
        }

      } catch (err) {
        toast(err.message || '伺服器錯誤，請稍後再試。', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '立即預約';
      }
    });

    function toast(msg, type){
      if (type === 'hide'){ statusEl.style.display='none'; return; }
      statusEl.textContent = msg || '';
      statusEl.className = '';
      if (type === 'success') statusEl.classList.add('success');
      if (type === 'error')   statusEl.classList.add('error');
      statusEl.style.display = msg ? 'block' : 'none';
    }

    // 取消雙擊放大（iOS）
    let lastTouch = 0;
    document.addEventListener('touchend', (e)=>{
      const now = Date.now();
      if (now - lastTouch <= 300) e.preventDefault();
      lastTouch = now;
    }, {passive:false});
  </script>
</body>
</html>
