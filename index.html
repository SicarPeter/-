<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <title>標車酷預約系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" rel="stylesheet" />
  <style>
    :root{
      --bg:#191935; --card:#1f1f3f; --text:#f0f0f0; --muted:#9aa0b4;
      --accent:#D9F107; --input:#2a2a47; --border:#3f3f61; --danger:#ff8c8c; --success:#8cff8c;
      --ctrl-h: 48px; /* 控制所有輸入/下拉一致高度 */
    }
    html,body{height:100%}
    html{-webkit-text-size-adjust:100%}
    body{
      font-family:'Noto Sans TC',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol',sans-serif;
      background:var(--bg); color:var(--text); margin:0;
      display:flex; align-items:flex-start; justify-content:center;
      min-height:100svh;
      padding: max(16px,calc(16px + env(safe-area-inset-top))) 16px 24px;
    }
    .container{
      width:100%; max-width:720px; background:var(--card); border-radius:14px; padding:24px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    h1{margin:0; font-size:clamp(22px,4.2vw,32px); color:var(--accent); text-align:center; font-weight:800;}
    .sub{margin:6px 0 18px; text-align:center; color:var(--muted); font-size:14px}

    .grid{display:grid; gap:16px}
    .row{display:grid; gap:16px; grid-template-columns:1fr 1fr}

    .form-group{display:grid; gap:8px; align-self:start}
    label{font-weight:700; font-size:14px}

    /* 統一控制項外觀（避免文字上漂/高度不一） */
    .control{
      font:inherit; font-size:16px;
      height:var(--ctrl-h); line-height:calc(var(--ctrl-h) - 2px);
      width:100%; padding:10px 14px; border-radius:10px; border:1px solid var(--border);
      background:var(--input); color:var(--text); box-sizing:border-box;
      -webkit-appearance:none; appearance:none;
    }
    select.control{
      padding-right:40px;
      background-image:
        linear-gradient(45deg,transparent 50%,#9aa0b4 50%),
        linear-gradient(135deg,#9aa0b4 50%,transparent 50%);
      background-position: right 18px center, right 12px center;
      background-size:6px 6px,6px 6px;
      background-repeat:no-repeat;
    }
    textarea.control{height:auto; min-height:96px; line-height:1.5}
    .help{color:var(--muted); font-size:12px; min-height:18px}
    .help.spacer{visibility:hidden} /* 讓左右欄高度一致 */

    button.control{
      background:var(--accent); color:#101020; border:none; font-weight:800; cursor:pointer; height:var(--ctrl-h);
    }
    button.control:disabled{opacity:.6; cursor:not-allowed}

    #status{display:none; margin-top:4px; font-weight:700; text-align:center}
    #status.success{display:block; color:var(--success)}
    #status.error{display:block; color:var(--danger)}
    .field-error{color:var(--danger); font-size:12px; margin-top:-6px}

    @media (max-width:760px){
      .container{padding:18px}
      .row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>標車酷預約系統</h1>
    <p class="sub">定點檢測 · 台北市中山區濱江街 326-1 號</p>

    <form id="form" class="grid" novalidate>
      <div class="form-group">
        <label for="item">預約項目</label>
        <select id="item" name="item" class="control" required>
          <option value="車輛檢測">車輛檢測</option>
        </select>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="datepicker">日期</label>
          <input id="datepicker" name="date" type="text" inputmode="none" autocomplete="off" class="control" required>
          <div class="help">可約 2 個月內</div>
        </div>
        <div class="form-group">
          <label for="slot">時段</label>
          <select id="slot" name="time" class="control" required disabled>
            <option value="">請先選擇日期</option>
          </select>
          <div class="help spacer">占位</div>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="brand">廠牌</label>
          <select id="brand" name="brand" class="control" required disabled>
            <option value="">載入中...</option>
          </select>
          <div id="brandErr" class="field-error" style="display:none"></div>
        </div>
        <div class="form-group">
          <label for="model">車款</label>
          <select id="model" name="model" class="control" required disabled>
            <option value="">請先選擇廠牌</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="name">姓名</label>
          <input id="name" name="name" type="text" class="control" placeholder="請輸入您的姓名" required>
        </div>
        <div class="form-group">
          <label for="phone">手機號碼</label>
          <input id="phone" name="phone" type="tel" inputmode="numeric" class="control"
                 pattern="^(09|\\+?8869)\\d{8}$" placeholder="09xxxxxxxx" required autocomplete="tel-national">
        </div>
      </div>

      <div class="form-group">
        <label for="email">電子郵件</label>
        <input id="email" name="email" type="email" class="control" placeholder="example@gmail.com" required autocomplete="email">
      </div>

      <div class="form-group">
        <label for="memo">備註（可輸入 LINE ID 或其他需求）</label>
        <textarea id="memo" name="memo" class="control" rows="3" placeholder="選填"></textarea>
      </div>

      <button id="submit" type="submit" class="control">立即預約</button>
      <div id="status"></div>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
  <script>
    // === 後端 Apps Script Web App（/exec 結尾）===
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxKNqFkl3FqdskRQ_zUD3xvsfUPPuI5RT-5qDW242o3WedCHGNdNT3U-m6k8XT1nG8o/exec';

    // DOM
    const form      = document.getElementById('form');
    const dateEl    = document.getElementById('datepicker');
    const slotEl    = document.getElementById('slot');
    const brandEl   = document.getElementById('brand');
    const modelEl   = document.getElementById('model');
    const brandErr  = document.getElementById('brandErr');
    const statusEl  = document.getElementById('status');
    const submitBtn = document.getElementById('submit');

    // 日期選擇器
    const today = new Date();
    const max   = new Date(); max.setMonth(max.getMonth()+2);
    const picker = new Litepicker({
      element: dateEl,
      singleMode: true,
      lang: 'zh-TW',
      format: 'YYYY-MM-DD',
      minDate: today,
      maxDate: max,
      autoApply: true,
      mobileFriendly: true,
    });
    picker.on('selected', (date) => {
      const d = date ? date.format('YYYY-MM-DD') : '';
      if (d) fetchSlots(d);
    });

    // 近 7 天預熱（第一次點日期時）
    const slotsCache = new Map();
    dateEl.addEventListener('focus', prewarmSlots, { once:true });
    function prewarmSlots(){
      const base = new Date();
      const q = [];
      for (let i=0;i<7;i++){
        const d = new Date(base.getFullYear(), base.getMonth(), base.getDate()+i);
        const s = d.toISOString().slice(0,10);
        if (!slotsCache.has(s)) q.push(s);
      }
      q.forEach(d=>{
        fetch(`${APPS_SCRIPT_URL}?action=slots&date=${encodeURIComponent(d)}`)
          .then(r=>r.json()).then(j=>{ if(j&&j.success) slotsCache.set(d, j.data||{}); })
          .catch(()=>{});
      });
    }

    // === 讀取品牌/車款（本機 data/，避免 CORS） ===
    initBrandsModels();
    async function initBrandsModels(){
      try{
        const brandsURL = new URL('./data/brands.json', document.baseURI).href;
        const modelsURL = new URL('./data/models.json', document.baseURI).href;

        const [bRes, mRes] = await Promise.all([
          fetch(brandsURL, {cache:'no-store'}),
          fetch(modelsURL, {cache:'no-store'})
        ]);
        if (!bRes.ok) throw new Error('brands.json 載入失敗（HTTP '+bRes.status+'）');
        if (!mRes.ok) throw new Error('models.json 載入失敗（HTTP '+mRes.status+'）');

        const rawBrands = await bRes.json();
        const rawModels = await mRes.json();

        const brands = normalizeBrands(rawBrands);           // [{id,name}]
        const models = normalizeModels(rawModels, brands);   // [{id,name,brand_id}]

        // ---- 填入品牌（只放純文字，避免 [object Object]）----
        brandEl.innerHTML = '<option value="">請選擇廠牌</option>';
        brands.forEach(b => {
          const name = String(b.name || '').trim();
          const id   = String(b.id   || name);
          if (name) brandEl.appendChild(new Option(name, id));
        });
        brandEl.disabled = false;
        brandErr.style.display = 'none';

        // ---- 切換品牌 -> 篩車款 ----
        brandEl.onchange = () => {
          const id = String(brandEl.value || '');
          modelEl.innerHTML = '<option value="">請選擇車款</option>';
          if (!id) { modelEl.disabled = true; return; }
          models.filter(m => String(m.brand_id) === id)
                .forEach(m => modelEl.appendChild(new Option(m.name, m.name)));
          modelEl.disabled = false;
        };

      }catch(err){
        brandEl.innerHTML = `<option value="">品牌載入失敗</option>`;
        modelEl.innerHTML = `<option value="">車款載入失敗</option>`;
        brandEl.disabled = true; modelEl.disabled = true;
        brandErr.textContent = (err && err.message) ? err.message : '未知錯誤';
        brandErr.style.display = 'block';
        console.error('[brands/models] load error:', err);
      }
    }

    // 品牌正規化：支援 array / {id:name} map / 物件陣列
    function normalizeBrands(src){
      const out = [];
      if (Array.isArray(src)){
        src.forEach((b,i)=>{
          if (typeof b === 'string'){ out.push({id:String(i+1), name:b}); }
          else if (b && typeof b === 'object'){
            const name = firstString(b.name, b.brand, b.brandName, b.label);
            const id   = firstDefined(b.id, b.brand_id, b.brandId, b.code, i+1, name);
            if (name) out.push({ id:String(id), name:String(name) });
          }
        });
      }else if (src && typeof src === 'object'){
        Object.entries(src).forEach(([k,v])=>{
          if (typeof v === 'string'){ out.push({id:String(k), name:v}); }
          else if (v && typeof v === 'object'){
            const name = firstString(v.name, v.brand, v.brandName, v.label);
            const id   = firstDefined(v.id, v.brand_id, v.brandId, v.code, k, name);
            if (name) out.push({ id:String(id), name:String(name) });
          }
        });
      }
      // 去重/清洗
      const seen = new Set();
      return out
        .map(b => ({ id:String(b.id).trim(), name:String(b.name).trim() }))
        .filter(b => b.name && !seen.has(b.id) && seen.add(b.id));
    }

    // 車款正規化：支援 [{...}] 或 {brandId:[...]}
    function normalizeModels(src, brands){
      const out = [];
      const nameToId = new Map(brands.map(b => [String(b.name), String(b.id)]));
      if (Array.isArray(src)){
        src.forEach((m,i)=>{
          if (!m) return;
          const name = firstString(m.name, m.model);
          let brand_id = firstDefined(m.brand_id, m.brandId);
          if (!brand_id){
            const bname = firstString(m.brand, m.brandName);
            if (bname && nameToId.has(bname)) brand_id = nameToId.get(bname);
          }
          const id = firstDefined(m.id, i+1);
          if (name && brand_id) out.push({ id:String(id), name:String(name), brand_id:String(brand_id) });
        });
      }else if (src && typeof src === 'object'){
        Object.entries(src).forEach(([bid, arr])=>{
          if (Array.isArray(arr)){
            arr.forEach((m,i)=>{
              const name = firstString(m?.name, m?.model);
              const id   = firstDefined(m?.id, i+1);
              if (name) out.push({ id:String(id), name:String(name), brand_id:String(bid) });
            });
          }
        });
      }
      return out;
    }

    function firstDefined(...vals){ for (const v of vals) if (v !== undefined && v !== null) return v; }
    function firstString(...vals){
      for (const v of vals){
        if (v == null) continue;
        if (typeof v === 'string') return v;
        if (typeof v === 'number') return String(v);
      }
      return '';
    }

    // === 載入可預約時段（GET /action=slots） ===
    async function fetchSlots(dateStr){
      if (slotsCache.has(dateStr)){ renderSlots(slotsCache.get(dateStr)); return; }
      setSelectLoading();
      const url = `${APPS_SCRIPT_URL}?action=slots&date=${encodeURIComponent(dateStr)}`;
      try{
        const ctrl = new AbortController();
        const timer = setTimeout(()=>ctrl.abort(), 10000);
        const res = await fetch(url, { method:'GET', mode:'cors', signal:ctrl.signal });
        clearTimeout(timer);
        const j = await res.json();
        if (!j.success) throw new Error(j.message || '無法載入時段');
        slotsCache.set(dateStr, j.data || {});
        renderSlots(j.data || {});
      }catch(err1){
        // 再嘗試一次（無 signal）
        try{
          const res2 = await fetch(url, { method:'GET', mode:'cors' });
          const j2 = await res2.json();
          if (!j2.success) throw new Error(j2.message || '無法載入時段');
          slotsCache.set(dateStr, j2.data || {});
          renderSlots(j2.data || {});
        }catch(err2){
          slotEl.innerHTML = `<option value="">無法載入時段</option>`;
          slotEl.disabled = true;
          console.error('[slots] load error:', err1, err2);
          toast('時段載入失敗：' + ((err2 && err2.message) || (err1 && err1.message) || '未知錯誤'), 'error');
        }
      }
    }
    function setSelectLoading(){ slotEl.disabled = true; slotEl.innerHTML = `<option value="">載入中...</option>`; }
    function renderSlots(slots){
      const keys = Object.keys(slots||{}).sort();
      slotEl.innerHTML = '';
      if (keys.length === 0){
        slotEl.innerHTML = `<option value="">當日已無可預約時段</option>`;
        slotEl.disabled = true; return;
      }
      slotEl.disabled = false;
      slotEl.appendChild(new Option('請選擇時段',''));
      keys.forEach(k => slotEl.appendChild(new Option(`${k}（剩餘 ${slots[k]} 位）`, k)));
    }

    // === 送出 ===
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const requiredIds = ['item','datepicker','slot','brand','model','name','phone','email'];
      for (const id of requiredIds){
        const el = (id==='slot') ? slotEl : document.getElementById(id);
        if (!el || !el.value){ toast('請填寫所有必填欄位。','error'); return; }
      }
      submitBtn.disabled = true; submitBtn.textContent = '提交中...'; toast('', 'hide');
      try{
        const payload = {
          action:'reserve',
          item:  document.getElementById('item').value,
          date:  dateEl.value,
          time:  slotEl.value,
          brand: brandEl.options[brandEl.selectedIndex]?.text || brandEl.value,
          model: modelEl.value,
          name:  document.getElementById('name').value,
          phone: document.getElementById('phone').value,
          email: document.getElementById('email').value,
          memo:  document.getElementById('memo').value || ''
        };
        const res  = await fetch(APPS_SCRIPT_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload),
          mode:'cors'
        });
        const j = await res.json();
        if (j.success){
          toast(j.message || '預約成功！','success');
          form.reset(); picker.clearSelection();
          slotEl.innerHTML = `<option value="">請先選擇日期</option>`; slotEl.disabled = true;
          modelEl.innerHTML = `<option value="">請先選擇廠牌</option>`; modelEl.disabled = true;
          slotsCache.delete(payload.date); // 讓下一次重新抓可用名額
        }else{
          throw new Error(j.message || '預約失敗');
        }
      }catch(err){
        console.error('[reserve] submit error:', err);
        toast(err.message || '伺服器錯誤，請稍後再試。','error');
      }finally{
        submitBtn.disabled = false; submitBtn.textContent = '立即預約';
      }
    });

    // 訊息提示
    function toast(msg, type){
      if (type === 'hide'){ statusEl.style.display = 'none'; return; }
      statusEl.textContent = msg || '';
      statusEl.className = '';
      if (type === 'success') statusEl.classList.add('success');
      if (type === 'error')   statusEl.classList.add('error');
      statusEl.style.display = msg ? 'block' : 'none';
    }

    // iOS 避免雙擊放大
    let lastTouch = 0;
    document.addEventListener('touchend', (e)=>{
      const now = Date.now();
      if (now - lastTouch <= 300) e.preventDefault();
      lastTouch = now;
    }, {passive:false});
  </script>
</body>
</html>
