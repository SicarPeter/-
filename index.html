<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <title>æ¨™è»Šé…·ï½œè»Šè¼›æª¢æ¸¬é ç´„ï½œä¸­å¤è»Š217é …å°ˆæ¥­æª¢æ¸¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="description" content="è³£è»Šå°±æ‰¾æ¨™è»Šé…·ï¼æˆ‘å€‘æä¾› 217 é …ä¸­å¤è»Šå°ˆæ¥­æª¢æ¸¬ï¼Œç”±é‘‘å®šå¸«ä¸Šæ¶å‰æª¢æ¸¬è»Šæ³ï¼Œæ’é™¤é‡å¤§äº‹æ•…èˆ‡æ³¡æ°´é¢¨éšªï¼Œå¹«åŠ©è²·å®¶å®‰å¿ƒã€è®“ä½ è³£è»Šæ›´é †åˆ©ã€‚" />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" rel="stylesheet" />
  <!-- âœ… æ–°å¢ Google reCAPTCHA v3 -->
  <script src="https://www.google.com/recaptcha/api.js?render=6LcSotkrAAAAAN17wjVrzK3M0XmRG2HTiaovvTUD"></script>
  <style>
    /* âœ… æ–°å¢ï¼šé€šç”¨ box-sizing è¦å‰‡ï¼Œé¿å… padding å½±éŸ¿æ’ç‰ˆ */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    :root{
      --bg:#191935; --card:#1f1f3f; --text:#f0f0f0; --muted:#9aa0b4;
      --accent:#D9F107; --input:#2a2a47; --border:#3f3f61; --danger:#ff8c8c; --success:#8cff8c;
      --ctrl-h:48px;
    }
    html,body{height:100%}
    html{-webkit-text-size-adjust:100%}
    body{
      font-family:'Noto Sans TC',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol',sans-serif;
      background:var(--bg); color:var(--text); margin:0;
      /* âœ… ä¿®æ”¹ï¼šç§»é™¤ flexï¼Œè®“ container è‡ªç„¶æ’æ»¿å¯¬åº¦ */
      min-height:100svh;
      padding:
        calc(16px + env(safe-area-inset-top))
        16px
        calc(16px + env(safe-area-inset-bottom))
        16px;
    }
    @supports not (padding: max(0px)) {
      body{ padding-top: 24px; padding-bottom: 24px; }
    }
    @media (max-width:760px){
      /* âœ… ä¿®æ”¹ï¼šç§»é™¤ align-items:flex-start; */
      .container{ margin-top: 8px; }
    }
    .container{
      width:100%; max-width:720px; background:var(--card); border-radius:14px; padding:24px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      /* âœ… æ–°å¢ï¼šè®“ container åœ¨ body ä¸­æ°´å¹³ç½®ä¸­ */
      margin-left: auto;
      margin-right: auto;
    }
    h1{margin:0; font-size:clamp(22px,4.2vw,32px); color:var(--accent); text-align:center; font-weight:800;}
    .sub{margin:6px 0 18px; text-align:center; color:var(--muted); font-size:14px}
    .grid{display:grid; gap:16px}
    .row{
      display:grid; grid-template-columns:1fr 1fr; gap:16px;
      align-items:start;
    }
    @media (max-width:760px){ .row{ grid-template-columns:1fr; } }
    .form-group{display:flex; flex-direction:column; gap:8px}
    .control{
      font:inherit; font-size:16px;
      height:var(--ctrl-h); padding:12px 14px; line-height:normal;
      width:100%; border-radius:10px; border:1px solid var(--border);
      background:var(--input); color:var(--text);
      /* âœ… æ–°å¢ï¼šè½‰å ´æ•ˆæœ */
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    /* âœ… æ–°å¢ï¼šæ¬„ä½é©—è­‰å¤±æ•—çš„æ¨£å¼ */
    .control.is-invalid {
      border-color: var(--danger);
      box-shadow: 0 0 0 2px rgba(255, 140, 140, 0.3);
    }
    select.control{ background-image:none; padding-right:14px; }
    @supports (-webkit-touch-callout:none){
      select.control{ padding-top:12px; padding-bottom:12px; }
    }
    textarea.control{ height:auto; min-height:96px; line-height:1.5 }
    .help{color:var(--muted); font-size:12px}
    button.control{
      background:var(--accent); color:#101020; border:none; font-weight:800; cursor:pointer;
      height:var(--ctrl-h);
    }
    button.control:disabled{opacity:.6; cursor:not-allowed}
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6); display: flex; align-items: center;
      justify-content: center; z-index: 1000; opacity: 0; visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal-overlay.show { opacity: 1; visibility: visible; }
    .modal-content {
      background: var(--card); padding: 24px; border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35); width: 90%; max-width: 400px;
      text-align: center; transform: scale(0.9); transition: transform 0.3s ease;
    }
    .modal-overlay.show .modal-content { transform: scale(1); }
    #modal-title {
      margin: 0 0 12px; font-size: 20px; font-weight: 700;
    }
    #modal-title.success { color: var(--success); }
    #modal-title.error { color: var(--danger); }
    #modal-message { margin: 0 0 20px; color: var(--muted); }
    #modal-close { width: 100%; }
    .form-group-agree {
      display: flex; align-items: center; gap: 10px; margin-top: 8px;
    }
    .form-group-agree label {
      font-size: 14px; color: var(--muted); font-weight: normal; cursor: pointer;
    }
    .form-group-agree input[type="checkbox"]:disabled + label {
      cursor: not-allowed; opacity: 0.7;
    }
    .form-group-agree input[type="checkbox"] {
      width: 18px; height: 18px; accent-color: var(--accent);
    }
    .form-group-agree a {
      color: var(--accent); text-decoration: none; font-weight: 600;
    }
    .form-group-agree a:hover { text-decoration: underline; }
    .modal-content.declaration {
      max-width: 600px; text-align: left;
    }
    #declaration-title {
      text-align: center; margin: 0 0 16px; font-size: 20px;
      font-weight: 700; color: var(--text);
    }
    #declaration-content {
      max-height: 60vh; overflow-y: auto; margin-bottom: 20px; padding-right: 10px;
    }
    #declaration-content ol {
      padding-left: 35px; margin: 0; line-height: 1.6; color: var(--muted);
    }
    #declaration-content li { margin-bottom: 12px; }
    .reminder-box {
      background-color: rgba(217, 241, 7, 0.1); border: 1px solid var(--accent);
      border-left-width: 4px; padding: 12px; border-radius: 8px;
      font-size: 13px; color: var(--text); margin-top: 4px; line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>æ¨™è»Šé…·é ç´„ç³»çµ±</h1>
    <p class="sub">å®šé»æª¢æ¸¬ Â· å°åŒ—å¸‚ä¸­å±±å€æ¿±æ±Ÿè¡— 326-1 è™Ÿ</p>
    <form id="form" class="grid" novalidate>
      <div class="form-group">
        <label for="item">é ç´„é …ç›®</label>
        <select id="item" name="item" class="control" required>
          <option value="è»Šè¼›æª¢æ¸¬">è»Šè¼›æª¢æ¸¬</option>
        </select>
      </div>
      <div class="row">
        <div class="form-group">
          <label for="datepicker">æ—¥æœŸ</label>
          <input id="datepicker" name="date" type="text" class="control" inputmode="none" autocomplete="off" placeholder="è«‹å…ˆé¸æ“‡æ—¥æœŸ" readonly required>
          <div class="help">å¯ç´„ 2 å€‹æœˆå…§ï¼Œé€±æ—¥ã€ä¸€å›ºå®šå…¬ä¼‘</div>
        </div>
        <div class="form-group">
          <label for="slot">æ™‚æ®µ</label>
          <select id="slot" name="time" class="control" required disabled>
            <option value="">è«‹å…ˆé¸æ“‡æ—¥æœŸ</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="form-group">
          <label for="brand">å» ç‰Œ</label>
          <select id="brand" name="brand" class="control" required disabled>
            <option value="">è¼‰å…¥ä¸­...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="model">è»Šæ¬¾</label>
          <select id="model" name="model" class="control" required disabled>
            <option value="">è«‹å…ˆé¸æ“‡å» ç‰Œ</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label for="year">å¹´ä»½</label>
        <select id="year" name="year" class="control" required>
          <option value="">è«‹é¸æ“‡å¹´ä»½</option>
        </select>
      </div>
      <div class="row">
        <div class="form-group">
          <label for="name">å§“å</label>
          <input id="name" name="name" type="text" class="control" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" required>
        </div>
        <div class="form-group">
          <label for="phone">æ‰‹æ©Ÿè™Ÿç¢¼</label>
          <input id="phone" name="phone" type="tel" class="control" inputmode="numeric" pattern="^(09|\\+?8869)\\d{8}$" placeholder="09xxxxxxxx" required>
        </div>
      </div>
      <div class="form-group">
        <label for="email">é›»å­éƒµä»¶</label>
        <input id="email" name="email" type="email" class="control" placeholder="example@gmail.com" required>
      </div>
      <div class="form-group">
        <label for="memo">å‚™è¨»ï¼ˆå¯è¼¸å…¥ LINE ID æˆ–å…¶ä»–éœ€æ±‚ï¼‰</label>
        <textarea id="memo" name="memo" class="control" rows="3" placeholder="é¸å¡«"></textarea>
        <div class="reminder-box">æª¢æ¸¬å‰è«‹å°‡è»Šè¼›å¤–è§€æ¸…æ´—ã€å…§éƒ¨ç‰©å“ç§»é™¤ ; æª¢æ¸¬è»Šè¼›åŒæ™‚æœƒæ‹ç…§ , ä½œç‚ºä¸Šæ¶è²©å”®ä½¿ç”¨(æª¢æ¸¬æ™‚é–“ 1~1.5h)</div>
      </div>
      <div class="form-group-agree">
        <input type="checkbox" id="agree" name="agree" required disabled>
        <label for="agree">æˆ‘å·²é–±è®€ä¸¦åŒæ„<a href="javascript:void(0);" id="open-declaration">æª¢æ¸¬è²æ˜äº‹é …</a></label>
      </div>
      <button id="submit" type="submit" class="control" disabled>ç«‹å³é ç´„</button>
    </form>
  </div>

  <div id="modal" class="modal-overlay">
    <div class="modal-content">
      <h2 id="modal-title"></h2>
      <p id="modal-message"></p>
      <button id="modal-close" class="control">é—œé–‰</button>
    </div>
  </div>

  <div id="declaration-modal" class="modal-overlay">
    <div class="modal-content declaration">
      <h2 id="declaration-title">æª¢æ¸¬è²æ˜äº‹é …</h2>
      <div id="declaration-content">
        <ol>
            <li>å› å—æª¢æ¸¬æ–¹å¼ã€è¨­å‚™ä¹‹é™åˆ¶ï¼Œæ•…ç„¡æ³•æª¢æŸ¥å¼•æ“å…§éƒ¨é‹è½‰ç‹€æ³ï¼ŒåŒ…å«å…§éˆã€åƒæ©Ÿæ²¹ç­‰å…§éƒ¨ä¹‹é›¶ä»¶æˆ–ç¾è±¡ã€‚</li>
            <li>è»Šè¼›æª¢æ¸¬çš†æ¡ç›®è¦–æª¢æŸ¥ï¼Œè®Šé€Ÿç®±ã€åŠ åŠ›ç®±ã€å±¬æ–¼å°é–‰å¼é›¶ä»¶ï¼Œç„¡æ³•æª¢è¦–å…§éƒ¨ç£¨æç¨‹åº¦ã€‚</li>
            <li>åº•ç›¤é›¶ä»¶å› æª¢æ¸¬ç„¡æ³•èˆ‰å‡ï¼Œåº•ç›¤é›¶ä»¶é™¤é¿éœ‡å™¨å¤–ï¼Œç„¡æ³•æª¢æŸ¥è€—æç¨‹åº¦ã€‚</li>
            <li>48Vè¼”åŠ©é›»ç“¶æˆ–é›»å‹•è»Šä¹‹é›»æ± å¥åº·åº¦ä¸åœ¨æª¢æ¸¬ç¯„åœå…§ã€‚</li>
            <li>ç¢³çº–ç¶­æˆ–å¡‘è† éˆ‘ä»¶åŠè£½å“ä¸åœ¨æª¢æ¸¬ç¯„åœå…§ã€‚</li>
            <li>è»Šé«”å¤–è§€å¦‚æœ‰åŒ…è†œå‰‡ç„¡æ³•æª¢æ¸¬å¤–è§€éˆ‘ä»¶æœ‰ç„¡åˆ®å‡¹ç—•ç¾è±¡ã€‚</li>
            <li>éèˆ‰å‡æª¢æŸ¥æ‰€èƒ½ç™¼ç¾ä¹‹çµæ§‹æå‚·å°‡ä¸åœ¨æª¢æ¸¬ç¯„åœå…§ã€‚</li>
            <li>æª¢æ¸¬æ™‚éœ€è¦–æƒ…æ³æ‹†é£¾æ¿åŠé–€é‚Šè† æ¢æª¢æŸ¥ï¼Œå› ç‰©å“è‡ªç„¶è€åŒ–é€ æˆä¹‹æå£å‡ä¸äºˆä»¥è³ å„Ÿã€‚</li>
            <li>æª¢è¦–æ•ç¯·è»Šå‹è¦–æƒ…æ³æª¢æŸ¥é–‹é—œåŠŸèƒ½æ˜¯å¦ç•°å¸¸ï¼Œå› ç‰©å“è‡ªç„¶è€åŒ–é€ æˆæå£ä¸äºˆä»¥è³ å„Ÿã€‚</li>
            <li>å¤©çª—æª¢æŸ¥æ™‚éœ€ä½œå‹•æ¸¬è©¦ï¼Œå› é›»å™¨é¡è‡ªç„¶è€åŒ–é€ æˆæå£å‡ä¸äºˆä»¥è³ å„Ÿã€‚</li>
            <li>æ¥­ç•Œç›®å‰å°šç„¡æŠ€è¡“æª¢æ¸¬è»Šè¼›é‡Œç¨‹ä¹‹æ­£ç¢ºæ€§ï¼Œæª¢æ¸¬å ±å‘Šåƒ…ç™»éŒ„å„€è¡¨æ¿ç‡ˆä¸‹é¡¯ç¤ºä¹‹é‡Œç¨‹ï¼Œä¸ä»£è¡¨è»Šè¼›æ­£ç¢ºä¹‹é‡Œç¨‹ã€‚</li>
            <li>è»Šè¼›æª¢æŸ¥çš†ä»¥ç›®è¦–è©•ä¼°ï¼Œä¸¦ç„¡æ‹†å¸å¼•æ“ã€è®Šé€Ÿç®±ã€åŠè»Šè¼›é›¶çµ„ä»¶ã€Œè»Šè¼›æª¢æ¸¬å–®ã€ä»¥æ¨™è»Šé…·è»Šè¼›æª¢æ¸¬å¸«é™³è¿°æª¢æŸ¥çµæœã€‚</li>
            <li>æœ¬æª¢æ¸¬å ±å‘Šåƒ…æä¾›è»Šæ³äºˆè²·è³£é›™æ–¹åƒè€ƒï¼Œä¸ä»£è¡¨è»Šè¼›å”®åƒ¹èƒ½å®Œæ•´åæ˜ è»Šæ³ã€‚</li>
            <li>æœ¬æª¢æ¸¬å ±å‘Šåƒ…å°è»Šè¼›æª¢æ¸¬ç•¶æ™‚è»Šæ³é€²è¡Œè©•ä¼°ï¼Œä¸ä»£è¡¨ç„¡ç•°ç‹€ä¹‹éƒ¨åˆ†åœ¨æ—¥å¾Œä¸æœƒæœ‰æ•…éšœæˆ–ä¸è‰¯ä¹‹æƒ…æ³ã€‚</li>
            <li>æœ¬æª¢æ¸¬å ±å‘Šåƒ…ä¾›è²·è³£é›™æ–¹åƒè€ƒï¼Œä¸ä½œç‚ºæ³•å¾‹è¨Ÿè¨Ÿä¹‹æ–‡ä»¶ã€‚</li>
        </ol>
      </div>
      <button id="declaration-close" class="control">æˆ‘æ˜ç™½äº†</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
  <script>
    /* ===== Endpoints ===== */
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxKNqFkl3FqdskRQ_zUD3xvsfUPPuI5RT-5qDW242o3WedCHGNdNT3U-m6k8XT1nG8o/exec';
    const BRAND_JSON = './data/brands.json';
    const MODEL_JSON = './data/models.json';

    /* ===== DOM ===== */
    const form = document.getElementById('form');
    const dateEl = document.getElementById('datepicker');
    const slotEl = document.getElementById('slot');
    const brandEl = document.getElementById('brand');
    const modelEl = document.getElementById('model');
    const yearEl = document.getElementById('year');
    const submitBtn = document.getElementById('submit');
    const agreeCheckbox = document.getElementById('agree');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalCloseBtn = document.getElementById('modal-close');
    const openDeclarationLink = document.getElementById('open-declaration');
    const declarationModal = document.getElementById('declaration-modal');
    const declarationCloseBtn = document.getElementById('declaration-close');
    
    let hasReadDeclaration = false;
    let picker; // âœ… æå‡ picker è®Šæ•¸ä½œç”¨åŸŸ

    /* ===== Slots å¿«å–è¨­å®š ===== */
let slotsCache = {};
const SLOTS_CACHE_KEY = 'slotsCache';
const SLOTS_CACHE_TTL = 300; // ç§’ (5åˆ†é˜)

    /* ===== Modal Logic ===== */
    function showModal(message, type) {
      modalTitle.textContent = '';
      modalTitle.className = '';
      modalMessage.textContent = message || '';
      if (type === 'success') {
        modalTitle.textContent = 'é ç´„æˆåŠŸï¼';
        modalTitle.classList.add('success');
      }
      if (type === 'error') {
        modalTitle.textContent = 'æ“ä½œå¤±æ•—';
        modalTitle.classList.add('error');
      }
      modal.classList.add('show');
    }
    function hideModal() { modal.classList.remove('show'); }
    modalCloseBtn.addEventListener('click', hideModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });

    /* ===== è²æ˜äº‹é … Modal ===== */
    openDeclarationLink.addEventListener('click', (e) => {
      e.preventDefault();
      declarationModal.classList.add('show');
    });
    declarationCloseBtn.addEventListener('click', () => {
      declarationModal.classList.remove('show');
      agreeCheckbox.disabled = false;
      hasReadDeclaration = true;
    });

    /* ===== Date Picker ===== */
    const today = new Date();
    const max = new Date(); max.setMonth(max.getMonth() + 2);
    let closedDays = [];

    async function fetchClosedDays() {
      try {
        const res = await fetch(`${APPS_SCRIPT_URL}?action=closed-days`);
        const json = await res.json();
        if (json.success && Array.isArray(json.data)) {
          closedDays = json.data;
        }
      } catch (err) {
        console.error('Failed to fetch closed days:', err);
      }
      initPicker();
    }

    function initPicker() {
      picker = new Litepicker({ // âœ… è³¦å€¼çµ¦ picker
        element: dateEl,
        singleMode: true,
        lang: 'zh-TW',
        format: 'YYYY-MM-DD',
        minDate: today, // âœ… å°‡ minDate ç§»å›æ­¤è™•
        maxDate: max,
        autoApply: true,
        mobileFriendly: true,
        lockDaysFilter: (date) => {
          const day = date.getDay();
          const dateStr = date.format('YYYY-MM-DD');
          // âœ… ç¦æ­¢é€±æ—¥ (0) & é€±ä¸€ (1) & å¾Œç«¯å›å‚³çš„é—œé–‰æ—¥
      return day === 0 || day === 1 || closedDays.includes(dateStr);
        },
      });
      picker.on('selected', (date) => {
        const d = date ? date.format('YYYY-MM-DD') : '';
        if (d) fetchSlots(d);
      });
    }
    fetchClosedDays();
    initSlotsCache(); // é é¢è¼‰å…¥å°±å…ˆæŠ“ 30 å¤©è³‡æ–™


    /* ===== Local cache ===== */
    const LS = {
      get(k, sec){ try{ const v = JSON.parse(localStorage.getItem(k) || 'null'); if(!v) return null; if(sec && (Date.now() - v.t)/1000 > sec) return null; return v.v; }catch{return null} },
      set(k, v){ localStorage.setItem(k, JSON.stringify({t:Date.now(), v})) }
    };
    
    /* ===== åˆå§‹åŒ–ï¼šå¹´ä»½ ===== */
    function initYear() {
      const startYear = 2010;
      const endYear = new Date().getFullYear() + 1; // å‹•æ…‹å–å¾—ä»Šå¹´+1
      yearEl.innerHTML = '<option value="">è«‹é¸æ“‡å¹´ä»½</option>';
      for (let i = endYear; i >= startYear; i--) {
        yearEl.appendChild(new Option(i, i));
      }
    }
    initYear();

/* ===== åˆå§‹åŒ–ï¼šæ™‚æ®µå¿«å– ===== */
async function initSlotsCache() {
  try {
    const cached = LS.get(SLOTS_CACHE_KEY, SLOTS_CACHE_TTL);
    if (cached) {
      slotsCache = cached;
      console.log('%c[slotsCache] ä½¿ç”¨ localStorage å¿«å–', 'color: #4caf50; font-weight: bold;');
      return;
    }

    const res = await fetch(`${APPS_SCRIPT_URL}?action=slots-range&range=30`);
    const json = await res.json();
    if (json.success && json.data) {
      slotsCache = json.data;
      LS.set(SLOTS_CACHE_KEY, slotsCache);
      console.log('%c[slotsCache] å·²å¾å¾Œç«¯æ›´æ–° 30 å¤©æ™‚æ®µ', 'color: #2196f3; font-weight: bold;', slotsCache);
    }
  } catch (err) {
    console.error('è¼‰å…¥ slots-range å¤±æ•—', err);
  }
}

    /* ===== åˆå§‹åŒ–ï¼šå“ç‰Œ & è»Šæ¬¾ ===== */
    initBrands();
    async function initBrands(){
      brandEl.disabled = true; brandEl.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';
      const cached = LS.get('brands', 86400);
      if (cached) renderBrands(cached);
      try{
        const res = await fetch(BRAND_JSON, {cache:'force-cache'});
        const data = await res.json();
        let list = [];
        if (Array.isArray(data)) { list = data.map(x => typeof x === 'string' ? ({id:x, name:x}) : ({id:(x.id??x.value??x.code??x.name), name:(x.name??x.label??String(x.id??x.value??x.code??x))})); }
        else if (data && Array.isArray(data.brands)) { list = data.brands.map(x => typeof x === 'string' ? ({id:x, name:x}) : ({id:(x.id??x.value??x.code??x.name), name:(x.name??x.label??String(x.id??x.value??x.code??x))})); }
        else if (data && typeof data === 'object') { list = Object.keys(data).map(k => ({id:k, name:k})); }
        if (!list.length) throw new Error('brands.json æ ¼å¼ä¸ç¬¦');
        LS.set('brands', list);
        renderBrands(list);
        const first = list[0]?.id;
        if (first) fetchModels(first, {silent:true});
      }catch(e){
        console.warn('load brands error', e);
        if (!cached){ brandEl.innerHTML = '<option value="">å“ç‰Œè¼‰å…¥å¤±æ•—</option>'; brandEl.disabled = true; }
      }
    }
    brandEl.addEventListener('change', () => {
      const id = brandEl.value;
      if (!id){ modelEl.disabled = true; modelEl.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡å» ç‰Œ</option>'; return; }
      fetchModels(id);
    });
    async function fetchModels(brandId, {silent=false} = {}){
      const CK = 'models:' + brandId;
      const cached = LS.get(CK, 21600);
      if (cached) renderModels(cached);
      if (!silent){ modelEl.disabled = true; modelEl.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>'; }
      try{
        const res = await fetch(MODEL_JSON, {cache:'force-cache'});
        const data = await res.json();
        let list = [];
        if (Array.isArray(data)) { list = data.filter(x => String(x.brand_id??x.brandId??x.BrandId) === String(brandId)).map(x => ({id:(x.id??x.value??x.code??x.name), name:(x.name??x.label??String(x.id))})); }
        else if (data && typeof data === 'object') {
          const byKey = data[String(brandId)] || data[brandEl.options[brandEl.selectedIndex].text] || null;
          if (Array.isArray(byKey)) { list = byKey.map(x => typeof x === 'string' ? ({id:x, name:x}) : ({id:(x.id??x.value??x.code??x.name), name:(x.name??x.label??String(x.id))})); }
        }
        if (!list.length) { modelEl.disabled = true; modelEl.innerHTML = '<option value="">æ­¤å» ç‰Œå°šç„¡è»Šæ¬¾</option>'; return; }
        LS.set(CK, list);
        renderModels(list);
      }catch(e){
        console.warn('load models error', e);
        if (!cached){ modelEl.disabled = true; modelEl.innerHTML = '<option value="">è»Šæ¬¾è¼‰å…¥å¤±æ•—</option>'; }
      }
    }
    function renderBrands(list){
      brandEl.innerHTML = '<option value="">è«‹é¸æ“‡å» ç‰Œ</option>';
      list.forEach(b => brandEl.appendChild(new Option(String(b.name), String(b.id))));
      brandEl.disabled = false;
    }
    function renderModels(list){
      modelEl.innerHTML = '<option value="">è«‹é¸æ“‡è»Šæ¬¾</option>';
      list.forEach(m => modelEl.appendChild(new Option(String(m.name), String(m.id))));
      modelEl.disabled = false;
    }

/* ===== æ™‚æ®µï¼ˆä½¿ç”¨å¿«å–ï¼‰ ===== */
function normalizeDate(dateStr) {
  const d = new Date(dateStr);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

async function fetchSlots(dateStr) {
  dateStr = normalizeDate(dateStr); // ğŸ”‘ å¼·åˆ¶è½‰æˆ yyyy-MM-dd
  console.log('[fetchSlots] æ­£è¦åŒ–æ—¥æœŸ:', dateStr, 'slots=', slotsCache[dateStr]);

  slotEl.disabled = true;
  slotEl.innerHTML = `<option value="">è¼‰å…¥ä¸­...</option>`;

  try {
    const slots = slotsCache[dateStr] || {};
    let keys = Object.keys(slots).sort();

    const today = new Date();
    const selectedDate = new Date(dateStr);
    const isToday = selectedDate.setHours(0,0,0,0) === today.setHours(0,0,0,0);

    if (isToday) {
      const now = new Date();
      const currentMinutes = now.getHours() * 60 + now.getMinutes();
      keys = keys.filter(k => {
        const [hour, minute] = k.split(':').map(Number);
        return hour * 60 + minute > currentMinutes + 10;
      });
    }

    slotEl.innerHTML = '';
    if (!keys.length) {
      slotEl.innerHTML = `<option value="">ç•¶æ—¥å·²ç„¡å¯é ç´„æ™‚æ®µ</option>`;
      slotEl.disabled = true;
      return;
    }

    slotEl.appendChild(new Option('è«‹é¸æ“‡æ™‚æ®µ',''));
    let allFull = true;
    keys.forEach(k => {
      const opt = new Option(`${k}ï¼ˆå‰©é¤˜ ${slots[k]} ä½ï¼‰`, k);
      if (slots[k] <= 0) {
        opt.disabled = true;
      } else {
        allFull = false;
      }
      slotEl.appendChild(opt);
    });

    if (allFull) {
      slotEl.innerHTML = `<option value="">ç•¶æ—¥å·²ç„¡å¯é ç´„æ™‚æ®µ</option>`;
      slotEl.disabled = true;
      return;
    }

    slotEl.disabled = false;
  } catch (err) {
    console.error('fetchSlots error:', err);
    slotEl.innerHTML = `<option value="">ç„¡æ³•è¼‰å…¥æ™‚æ®µ</option>`;
    slotEl.disabled = true;
  }
}

    /* ===== å•Ÿç”¨/ç¦ç”¨é€å‡ºæŒ‰éˆ• ===== */
    agreeCheckbox.addEventListener('change', () => { submitBtn.disabled = !agreeCheckbox.checked; });

    /* ===== è¡¨å–®é©—è­‰ ===== */
    const fieldNames = { item: 'é ç´„é …ç›®', datepicker: 'æ—¥æœŸ', slot: 'æ™‚æ®µ', brand: 'å» ç‰Œ', model: 'è»Šæ¬¾', year: 'å¹´ä»½', name: 'å§“å', phone: 'æ‰‹æ©Ÿè™Ÿç¢¼', email: 'é›»å­éƒµä»¶' };
    function validateForm() {
      // æ¸…é™¤èˆŠçš„éŒ¯èª¤æç¤º
      document.querySelectorAll('.control.is-invalid').forEach(el => el.classList.remove('is-invalid'));
      
      const requiredIds = ['item','datepicker','slot','brand','model','year','name','phone','email'];
      for (const id of requiredIds) {
        const el = document.getElementById(id);
        if (!el || !el.value) {
          return { id, message: `è«‹é¸æ“‡æˆ–å¡«å¯«ã€Œ${fieldNames[id]}ã€ã€‚` };
        }
      }
      if (!agreeCheckbox.checked) {
        return { id: 'agree', message: 'è«‹å…ˆé–±è®€ä¸¦åŒæ„æª¢æ¸¬è²æ˜äº‹é …ã€‚' };
      }
      return null;
    }

    /* ===== é€å‡º ===== */
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const validationError = validateForm();
      if (validationError) {
        showModal(validationError.message, 'error');
        const errorEl = document.getElementById(validationError.id);
        if (errorEl) {
          errorEl.classList.add('is-invalid');
          errorEl.focus({ preventScroll: true });
          errorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return;
      }

      submitBtn.disabled = true; submitBtn.textContent = 'é ç´„ä¸­...';

      try {
          // âœ… å…ˆå–å¾— reCAPTCHA token
        const token = await grecaptcha.execute('6LcSotkrAAAAAN17wjVrzK3M0XmRG2HTiaovvTUD', { action: 'reserve' });
        const params = new URLSearchParams(new FormData(form));
        params.set('action','reserve');
         params.set('recaptchaToken', token); // æŠŠ token å¸¶ä¸Šå»

        const res  = await fetch(APPS_SCRIPT_URL, {
          method:'POST',
          body: params,
          mode:'cors',
        });

        const ct = res.headers.get('content-type') || '';
        const data = ct.includes('application/json') ? await res.json() : { success:false, message:'ä¼ºæœå™¨æœªå› JSON' };

        if (data.success) {
          showModal(data.message || 'æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„é ç´„ï¼Œç¨å¾Œå°‡ä»¥ Email ç¢ºèªã€‚','success');
          form.reset();
          if (picker) picker.clearSelection();
          agreeCheckbox.checked = false;
          agreeCheckbox.disabled = true;
          hasReadDeclaration = false;
          submitBtn.disabled = true;
          slotEl.innerHTML = `<option value="">è«‹å…ˆé¸æ“‡æ—¥æœŸ</option>`; slotEl.disabled = true;
          modelEl.innerHTML = `<option value="">è«‹å…ˆé¸æ“‡å» ç‰Œ</option>`; modelEl.disabled = true;
        } else {
          throw new Error(data.message || 'é ç´„å¤±æ•—');
        }
      } catch (err) {
        showModal(err.message || 'é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚','error');
        // âœ… ä¿®æ”¹ï¼šå¤±æ•—æ™‚æ‰æ¢å¾©æŒ‰éˆ•
        submitBtn.disabled = !agreeCheckbox.checked;
      } finally {
        submitBtn.textContent = 'ç«‹å³é ç´„';
      }
    });

    // é¿å… iOS é›™æ“Šæ”¾å¤§
    let lastTouch = 0;
    document.addEventListener('touchend', (e)=>{
      const now = Date.now();
      if (now - lastTouch <= 300) e.preventDefault();
      lastTouch = now;
    }, {passive:false});
  </script>
</body>
</html>

