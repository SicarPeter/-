<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <title>æ¨™è»Šé…·é ç´„ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" rel="stylesheet" />
  <style>
    :root{
      --bg:#191935; --card:#1f1f3f; --text:#f0f0f0; --muted:#9aa0b4;
      --accent:#D9F107; --input:#2a2a47; --border:#3f3f61; --danger:#ff8c8c; --success:#8cff8c;
      --ctrl-h:48px;
    }
    html,body{height:100%}
    html{-webkit-text-size-adjust:100%}
    body{
      font-family:'Noto Sans TC',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol',sans-serif;
      background:var(--bg); color:var(--text); margin:0; display:flex; align-items:center; justify-content:center;
      min-height:100svh;
      padding:
        calc(16px + env(safe-area-inset-top))
        16px
        calc(16px + env(safe-area-inset-bottom))
        16px;
    }
    @supports not (padding: max(0px)) {
      body{ padding-top: 24px; padding-bottom: 24px; }
    }
    @media (max-width:760px){
      body{ align-items:flex-start; }
      .container{ margin-top: 8px; }
    }
    .container{
      width:100%; max-width:720px; background:var(--card); border-radius:14px; padding:24px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    h1{margin:0; font-size:clamp(22px,4.2vw,32px); color:var(--accent); text-align:center; font-weight:800;}
    .sub{margin:6px 0 18px; text-align:center; color:var(--muted); font-size:14px}
    .grid{display:grid; gap:16px}
    .row{
      display:grid; grid-template-columns:1fr 1fr; gap:16px;
      align-items:start;
    }
    @media (max-width:760px){ .row{ grid-template-columns:1fr; } }
    .form-group{display:flex; flex-direction:column; gap:8px}
    label{font-weight:700; font-size:14px}
    .control{
      font:inherit; font-size:16px;
      height:var(--ctrl-h); padding:12px 14px; line-height:normal;
      width:100%; border-radius:10px; border:1px solid var(--border);
      background:var(--input); color:var(--text); box-sizing:border-box;
    }
    select.control{ background-image:none; padding-right:14px; }
    @supports (-webkit-touch-callout:none){
      select.control{ padding-top:12px; padding-bottom:12px; }
    }
    textarea.control{ height:auto; min-height:96px; line-height:1.5 }
    .help{color:var(--muted); font-size:12px}
    button.control{
      background:var(--accent); color:#101020; border:none; font-weight:800; cursor:pointer;
      height:var(--ctrl-h);
    }
    button.control:disabled{opacity:.6; cursor:not-allowed}

    /* ===== Modal Styles (æ–°å¢) ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: var(--card);
      padding: 24px;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      width: 90%;
      max-width: 400px;
      text-align: center;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }
    .modal-overlay.show .modal-content {
      transform: scale(1);
    }
    #modal-title {
      margin: 0 0 12px;
      font-size: 20px;
      font-weight: 700;
    }
    #modal-title.success { color: var(--success); }
    #modal-title.error { color: var(--danger); }
    #modal-message {
      margin: 0 0 20px;
      color: var(--muted);
    }
    #modal-close {
      width: 100%;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>æ¨™è»Šé…·é ç´„ç³»çµ±</h1>
    <p class="sub">å®šé»æª¢æ¸¬ Â· å°åŒ—å¸‚ä¸­å±±å€æ¿±æ±Ÿè¡— 326-1 è™Ÿ</p>

    <form id="form" class="grid" novalidate>
      <!-- é …ç›® -->
      <div class="form-group">
        <label for="item">é ç´„é …ç›®</label>
        <select id="item" name="item" class="control" required>
          <option value="è»Šè¼›æª¢æ¸¬">è»Šè¼›æª¢æ¸¬</option>
        </select>
      </div>

      <!-- æ—¥æœŸ / æ™‚æ®µ -->
      <div class="row">
        <div class="form-group">
          <label for="datepicker">æ—¥æœŸ</label>
          <input id="datepicker" name="date" type="text" class="control" inputmode="none" autocomplete="off" placeholder="è«‹å…ˆé¸æ“‡æ—¥æœŸ" readonly required>
          <!-- âœ… ä¿®æ”¹ï¼šæç¤ºæ–‡å­— -->
          <div class="help">å¯ç´„ 2 å€‹æœˆå…§ï¼Œé€±ä¸€å…¬ä¼‘</div>
        </div>
        <div class="form-group">
          <label for="slot">æ™‚æ®µ</label>
          <select id="slot" name="time" class="control" required disabled>
            <option value="">è«‹å…ˆé¸æ“‡æ—¥æœŸ</option>
          </select>
        </div>
      </div>

      <!-- å» ç‰Œ / è»Šæ¬¾ -->
      <div class="row">
        <div class="form-group">
          <label for="brand">å» ç‰Œ</label>
          <select id="brand" name="brand" class="control" required disabled>
            <option value="">è¼‰å…¥ä¸­...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="model">è»Šæ¬¾</label>
          <select id="model" name="model" class="control" required disabled>
            <option value="">è«‹å…ˆé¸æ“‡å» ç‰Œ</option>
          </select>
        </div>
      </div>

      <!-- åŸºæœ¬è³‡æ–™ -->
      <div class="row">
        <div class="form-group">
          <label for="name">å§“å</label>
          <input id="name" name="name" type="text" class="control" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" required>
        </div>
        <div class="form-group">
          <label for="phone">æ‰‹æ©Ÿè™Ÿç¢¼</label>
          <input id="phone" name="phone" type="tel" class="control" inputmode="numeric" pattern="^(09|\\+?8869)\\d{8}$" placeholder="09xxxxxxxx" required>
        </div>
      </div>

      <div class="form-group">
        <label for="email">é›»å­éƒµä»¶</label>
        <input id="email" name="email" type="email" class="control" placeholder="example@gmail.com" required>
      </div>

      <div class="form-group">
        <label for="memo">å‚™è¨»ï¼ˆå¯è¼¸å…¥ LINE ID æˆ–å…¶ä»–éœ€æ±‚ï¼‰</label>
        <textarea id="memo" name="memo" class="control" rows="3" placeholder="é¸å¡«"></textarea>
      </div>

      <button id="submit" type="submit" class="control">ç«‹å³é ç´„</button>
      <!-- ğŸ—‘ï¸ ç§»é™¤ï¼šåŸæœ¬çš„ status div -->
    </form>
  </div>

  <!-- âœ… æ–°å¢ï¼šModal HTML çµæ§‹ -->
  <div id="modal" class="modal-overlay">
    <div class="modal-content">
      <h2 id="modal-title"></h2>
      <p id="modal-message"></p>
      <button id="modal-close" class="control">é—œé–‰</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
  <script>
    /* ===== Endpoints ===== */
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxKNqFkl3FqdskRQ_zUD3xvsfUPPuI5RT-5qDW242o3WedCHGNdNT3U-m6k8XT1nG8o/exec';
    const BRAND_JSON = './data/brands.json';
    const MODEL_JSON = './data/models.json';

    /* ===== DOM ===== */
    const form = document.getElementById('form');
    const dateEl = document.getElementById('datepicker');
    const slotEl = document.getElementById('slot');
    const brandEl = document.getElementById('brand');
    const modelEl = document.getElementById('model');
    // ğŸ—‘ï¸ ç§»é™¤ statusEl
    const submitBtn = document.getElementById('submit');
    // âœ… æ–°å¢ï¼šModal DOM å…ƒç´ 
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalCloseBtn = document.getElementById('modal-close');

    /* ===== Date Picker ===== */
    const today = new Date();
    const max = new Date(); max.setMonth(max.getMonth() + 2);
    const picker = new Litepicker({
      element: dateEl,
      singleMode: true,
      lang: 'zh-TW',
      format: 'YYYY-MM-DD',
      minDate: today,
      maxDate: max,
      autoApply: true,
      mobileFriendly: true,
      // âœ… æ–°å¢ï¼šç¦ç”¨é€±ä¸€ (0=é€±æ—¥, 1=é€±ä¸€, ...)
      lockDaysFilter: (date) => {
        const day = date.getDay();
        return day === 1;
      },
    });
    picker.on('selected', (date) => {
      const d = date ? date.format('YYYY-MM-DD') : '';
      if (d) fetchSlots(d);
    });

    /* ===== Modal Logic (æ–°å¢) ===== */
    function showModal(message, type) {
      modalTitle.textContent = '';
      modalTitle.className = '';
      modalMessage.textContent = message || '';

      if (type === 'success') {
        modalTitle.textContent = 'é ç´„æˆåŠŸï¼';
        modalTitle.classList.add('success');
      }
      if (type === 'error') {
        modalTitle.textContent = 'æ“ä½œå¤±æ•—';
        modalTitle.classList.add('error');
      }
      modal.classList.add('show');
    }

    function hideModal() {
      modal.classList.remove('show');
    }

    modalCloseBtn.addEventListener('click', hideModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        hideModal();
      }
    });


    /* ===== Local cacheï¼ˆbrandsï¼š24hï¼›modelsï¼šæ¯å“ç‰Œ 6hï¼‰ ===== */
    const LS = {
      get(k, sec){
        try{
          const v = JSON.parse(localStorage.getItem(k) || 'null');
          if(!v) return null;
          if(sec && (Date.now() - v.t)/1000 > sec) return null;
          return v.v;
        }catch{return null}
      },
      set(k, v){ localStorage.setItem(k, JSON.stringify({t:Date.now(), v})) }
    };

    /* ===== åˆå§‹åŒ–ï¼šå“ç‰Œ ===== */
    initBrands();
    async function initBrands(){
      brandEl.disabled = true;
      brandEl.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';

      const cached = LS.get('brands', 86400);
      if (cached) renderBrands(cached);

      try{
        const res = await fetch(BRAND_JSON, {cache:'force-cache'});
        const data = await res.json();
        let list = [];
        if (Array.isArray(data)) {
          list = data.map(x => typeof x === 'string' ? ({id:x, name:x}) : ({id:(x.id??x.value??x.code??x.name), name:(x.name??x.label??String(x.id??x.value??x.code??x))}));
        } else if (data && Array.isArray(data.brands)) {
          list = data.brands.map(x => typeof x === 'string' ? ({id:x, name:x}) : ({id:(x.id??x.value??x.code??x.name), name:(x.name??x.label??String(x.id??x.value??x.code??x))}));
        } else if (data && typeof data === 'object') {
          list = Object.keys(data).map(k => ({id:k, name:k}));
        }
        if (!list.length) throw new Error('brands.json æ ¼å¼ä¸ç¬¦');

        LS.set('brands', list);
        renderBrands(list);

        const first = list[0]?.id;
        if (first) fetchModels(first, {silent:true});
      }catch(e){
        console.warn('load brands error', e);
        if (!cached){
          brandEl.innerHTML = '<option value="">å“ç‰Œè¼‰å…¥å¤±æ•—</option>';
          brandEl.disabled = true;
        }
      }
    }

    brandEl.addEventListener('change', () => {
      const id = brandEl.value;
      if (!id){
        modelEl.disabled = true;
        modelEl.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡å» ç‰Œ</option>';
        return;
      }
      fetchModels(id);
    });

    async function fetchModels(brandId, {silent=false} = {}){
      const CK = 'models:' + brandId;
      const cached = LS.get(CK, 21600);
      if (cached) renderModels(cached);

      if (!silent){
        modelEl.disabled = true;
        modelEl.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';
      }

      try{
        const res = await fetch(MODEL_JSON, {cache:'force-cache'});
        const data = await res.json();

        let list = [];
        if (Array.isArray(data)) {
          list = data.filter(x => String(x.brand_id??x.brandId??x.BrandId) === String(brandId))
                     .map(x => ({id:(x.id??x.value??x.code??x.name), name:(x.name??x.label??String(x.id))}));
        } else if (data && typeof data === 'object') {
          const byKey = data[String(brandId)] || data[brandEl.options[brandEl.selectedIndex].text] || null;
          if (Array.isArray(byKey)) {
            list = byKey.map(x => typeof x === 'string' ? ({id:x, name:x}) : ({id:(x.id??x.value??x.code??x.name), name:(x.name??x.label??String(x.id))}));
          }
        }
        if (!list.length) {
          modelEl.disabled = true;
          modelEl.innerHTML = '<option value="">æ­¤å» ç‰Œå°šç„¡è»Šæ¬¾</option>';
          return;
        }

        LS.set(CK, list);
        renderModels(list);

      }catch(e){
        console.warn('load models error', e);
        if (!cached){
          modelEl.disabled = true;
          modelEl.innerHTML = '<option value="">è»Šæ¬¾è¼‰å…¥å¤±æ•—</option>';
        }
      }
    }

    function renderBrands(list){
      brandEl.innerHTML = '<option value="">è«‹é¸æ“‡å» ç‰Œ</option>';
      list.forEach(b => brandEl.appendChild(new Option(String(b.name), String(b.id))));
      brandEl.disabled = false;
    }
    function renderModels(list){
      modelEl.innerHTML = '<option value="">è«‹é¸æ“‡è»Šæ¬¾</option>';
      list.forEach(m => modelEl.appendChild(new Option(String(m.name), String(m.id))));
      modelEl.disabled = false;
    }

    /* ===== æ™‚æ®µï¼ˆApps Scriptï¼‰ ===== */
    async function fetchSlots(dateStr) {
      slotEl.disabled = true;
      slotEl.innerHTML = `<option value="">è¼‰å…¥ä¸­...</option>`;
      try {
        const url = `${APPS_SCRIPT_URL}?action=slots&date=${encodeURIComponent(dateStr)}`;
        const res = await fetch(url, { method: 'GET', mode: 'cors' });
        const json = await res.json();
        if (!json.success) throw new Error(json.message || 'ç„¡æ³•è¼‰å…¥æ™‚æ®µ');
        const slots = json.data || {};
        const keys = Object.keys(slots).sort();

        slotEl.innerHTML = '';
        if (!keys.length){
          slotEl.innerHTML = `<option value="">ç•¶æ—¥å·²ç„¡å¯é ç´„æ™‚æ®µ</option>`;
          slotEl.disabled = true;
          return;
        }
        slotEl.appendChild(new Option('è«‹é¸æ“‡æ™‚æ®µ',''));
        keys.forEach(k => slotEl.appendChild(new Option(`${k}ï¼ˆå‰©é¤˜ ${slots[k]} ä½ï¼‰`, k)));
        slotEl.disabled = false;
      } catch (err) {
        slotEl.innerHTML = `<option value="">ç„¡æ³•è¼‰å…¥æ™‚æ®µ</option>`;
        slotEl.disabled = true;
      }
    }

    /* ===== é€å‡ºï¼ˆx-www-form-urlencodedï¼Œé¿å… CORS é æª¢ï¼‰ ===== */
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const requiredIds = ['item','datepicker','slot','brand','model','name','phone','email'];
      for (const id of requiredIds) {
        const el = document.getElementById(id); // ç°¡åŒ–åˆ¤æ–·
        if (!el || !el.value) {
          // âœ… ä¿®æ”¹ï¼šå‘¼å« modal
          showModal('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ã€‚','error');
          return;
        }
      }

      submitBtn.disabled = true; submitBtn.textContent = 'æäº¤ä¸­...';

      try {
        const params = new URLSearchParams();
        params.set('action','reserve');
        params.set('item',  document.getElementById('item').value);
        params.set('date',  dateEl.value);
        params.set('time',  slotEl.value);
        params.set('name',  document.getElementById('name').value);
        params.set('phone', document.getElementById('phone').value);
        params.set('email', document.getElementById('email').value);
        params.set('memo',  document.getElementById('memo').value || '');
        params.set('brand', brandEl.value);
        params.set('model', modelEl.value);

        const res  = await fetch(APPS_SCRIPT_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=utf-8' },
          body: params.toString(),
          mode:'cors',
        });

        const ct = res.headers.get('content-type') || '';
        const data = ct.includes('application/json') ? await res.json()
                      : { success:false, message:'ä¼ºæœå™¨æœªå› JSONï¼ˆè«‹ç¢ºèª Web App æ¬Šé™/éƒ¨ç½²ï¼‰' };

        if (data.success) {
          // âœ… ä¿®æ”¹ï¼šå‘¼å« modal
          showModal(data.message || 'æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„é ç´„ï¼Œç¨å¾Œå°‡ä»¥ Email ç¢ºèªã€‚','success');
          form.reset();
          picker.clearSelection(); // æˆåŠŸå¾Œæ¸…é™¤æ—¥æœŸé¸æ“‡
          slotEl.innerHTML = `<option value="">è«‹å…ˆé¸æ“‡æ—¥æœŸ</option>`; slotEl.disabled = true;
          modelEl.innerHTML = `<option value="">è«‹å…ˆé¸æ“‡å» ç‰Œ</option>`; modelEl.disabled = true;
          brandEl.value = ''; // æ¸…é™¤å» ç‰Œé¸æ“‡
        } else {
          throw new Error(data.message || 'é ç´„å¤±æ•—');
        }
      } catch (err) {
        // âœ… ä¿®æ”¹ï¼šå‘¼å« modal
        showModal(err.message || 'é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚','error');
      } finally {
        submitBtn.disabled = false; submitBtn.textContent = 'ç«‹å³é ç´„';
      }
    });

    // ğŸ—‘ï¸ ç§»é™¤ï¼šèˆŠçš„ toast function

    // é¿å… iOS é›™æ“Šæ”¾å¤§
    let lastTouch = 0;
    document.addEventListener('touchend', (e)=>{
      const now = Date.now();
      if (now - lastTouch <= 300) e.preventDefault();
      lastTouch = now;
    }, {passive:false});
  </script>
</body>
</html>
