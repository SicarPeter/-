<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <title>標車酷｜車輛檢測預約｜中古車217項專業檢測</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="description" content="賣車就找標車酷！我們提供 217 項中古車專業檢測，由鑑定師上架前檢測車況，排除重大事故與泡水風險，幫助買家安心、讓你賣車更順利。" />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" rel="stylesheet" />
  <!-- ✅ 新增 Google reCAPTCHA v3 -->
  <script src="https://www.google.com/recaptcha/api.js?render=6LcSotkrAAAAAN17wjVrzK3M0XmRG2HTiaovvTUD"></script>
  <style>
    /* ✅ 新增：通用 box-sizing 規則，避免 padding 影響排版 */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    :root{
      --bg:#191935; --card:#1f1f3f; --text:#f0f0f0; --muted:#9aa0b4;
      --accent:#D9F107; --input:#2a2a47; --border:#3f3f61; --danger:#ff8c8c; --success:#8cff8c;
      --ctrl-h:48px;
    }
    html,body{height:100%}
    html{-webkit-text-size-adjust:100%}
    body{
      font-family:'Noto Sans TC',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,'Noto Sans','Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol',sans-serif;
      background:var(--bg); color:var(--text); margin:0;
      /* ✅ 修改：移除 flex，讓 container 自然撐滿寬度 */
      min-height:100svh;
      padding:
        calc(16px + env(safe-area-inset-top))
        16px
        calc(16px + env(safe-area-inset-bottom))
        16px;
    }
    @supports not (padding: max(0px)) {
      body{ padding-top: 24px; padding-bottom: 24px; }
    }
    @media (max-width:760px){
      /* ✅ 修改：移除 align-items:flex-start; */
      .container{ margin-top: 8px; }
    }
    .container{
      width:100%; max-width:720px; background:var(--card); border-radius:14px; padding:24px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      /* ✅ 新增：讓 container 在 body 中水平置中 */
      margin-left: auto;
      margin-right: auto;
    }
    h1{margin:0; font-size:clamp(22px,4.2vw,32px); color:var(--accent); text-align:center; font-weight:800;}
    .sub{margin:6px 0 18px; text-align:center; color:var(--muted); font-size:14px}
    .grid{display:grid; gap:16px}
    .row{
      display:grid; grid-template-columns:1fr 1fr; gap:16px;
      align-items:start;
    }
    @media (max-width:760px){ .row{ grid-template-columns:1fr; } }
    .form-group{display:flex; flex-direction:column; gap:8px}
    .control{
      font:inherit; font-size:16px;
      height:var(--ctrl-h); padding:12px 14px; line-height:normal;
      width:100%; border-radius:10px; border:1px solid var(--border);
      background:var(--input); color:var(--text);
      /* ✅ 新增：轉場效果 */
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    /* ✅ 新增：欄位驗證失敗的樣式 */
    .control.is-invalid {
      border-color: var(--danger);
      box-shadow: 0 0 0 2px rgba(255, 140, 140, 0.3);
    }
    select.control{ background-image:none; padding-right:14px; }
    @supports (-webkit-touch-callout:none){
      select.control{ padding-top:12px; padding-bottom:12px; }
    }
    textarea.control{ height:auto; min-height:96px; line-height:1.5 }
    .help{color:var(--muted); font-size:12px}
    button.control{
      background:var(--accent); color:#101020; border:none; font-weight:800; cursor:pointer;
      height:var(--ctrl-h);
    }
    button.control:disabled{opacity:.6; cursor:not-allowed}
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6); display: flex; align-items: center;
      justify-content: center; z-index: 1000; opacity: 0; visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal-overlay.show { opacity: 1; visibility: visible; }
    .modal-content {
      background: var(--card); padding: 24px; border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35); width: 90%; max-width: 400px;
      text-align: center; transform: scale(0.9); transition: transform 0.3s ease;
    }
    .modal-overlay.show .modal-content { transform: scale(1); }
    #modal-title {
      margin: 0 0 12px; font-size: 20px; font-weight: 700;
    }
    #modal-title.success { color: var(--success); }
    #modal-title.error { color: var(--danger); }
    #modal-message { margin: 0 0 20px; color: var(--muted); }
    #modal-close { width: 100%; }
    .form-group-agree {
      display: flex; align-items: center; gap: 10px; margin-top: 8px;
    }
    .form-group-agree label {
      font-size: 14px; color: var(--muted); font-weight: normal; cursor: pointer;
    }
    .form-group-agree input[type="checkbox"]:disabled + label {
      cursor: not-allowed; opacity: 0.7;
    }
    .form-group-agree input[type="checkbox"] {
      width: 18px; height: 18px; accent-color: var(--accent);
    }
    .form-group-agree a {
      color: var(--accent); text-decoration: none; font-weight: 600;
    }
    .form-group-agree a:hover { text-decoration: underline; }
    .modal-content.declaration {
      max-width: 600px; text-align: left;
    }
    #declaration-title {
      text-align: center; margin: 0 0 16px; font-size: 20px;
      font-weight: 700; color: var(--text);
    }
    #declaration-content {
      max-height: 60vh; overflow-y: auto; margin-bottom: 20px; padding-right: 10px;
    }
    #declaration-content ol {
      padding-left: 35px; margin: 0; line-height: 1.6; color: var(--muted);
    }
    #declaration-content li { margin-bottom: 12px; }
    .reminder-box {
      background-color: rgba(217, 241, 7, 0.1); border: 1px solid var(--accent);
      border-left-width: 4px; padding: 12px; border-radius: 8px;
      font-size: 13px; color: var(--text); margin-top: 4px; line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>標車酷預約系統</h1>
    <p class="sub">定點檢測 · 台北市中山區濱江街 326-1 號</p>
    <form id="form" class="grid" novalidate>
      <div class="form-group">
        <label for="item">預約項目</label>
        <select id="item" name="item" class="control" required>
          <option value="車輛檢測">車輛檢測</option>
        </select>
      </div>
      <div class="row">
        <div class="form-group">
          <label for="datepicker">日期</label>
          <input id="datepicker" name="date" type="text" class="control" inputmode="none" autocomplete="off" placeholder="請先選擇日期" readonly required>
          <div class="help">可約 2 個月內，週日、一固定公休</div>
        </div>
        <div class="form-group">
          <label for="slot">時段</label>
          <select id="slot" name="time" class="control" required disabled>
            <option value="">請先選擇日期</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="form-group">
          <label for="brand">廠牌</label>
          <select id="brand" name="brand" class="control" required disabled>
            <option value="">載入中...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="model">車款</label>
          <select id="model" name="model" class="control" required disabled>
            <option value="">請先選擇廠牌</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label for="year">年份</label>
        <select id="year" name="year" class="control" required>
          <option value="">請選擇年份</option>
        </select>
      </div>
      <div class="row">
        <div class="form-group">
          <label for="name">姓名</label>
          <input id="name" name="name" type="text" class="control" placeholder="請輸入您的姓名" required>
        </div>
        <div class="form-group">
          <label for="phone">手機號碼</label>
          <input id="phone" name="phone" type="tel" class="control" inputmode="numeric" pattern="^(09|\\+?8869)\\d{8}$" placeholder="09xxxxxxxx" required>
        </div>
      </div>
      <div class="form-group">
        <label for="email">電子郵件</label>
        <input id="email" name="email" type="email" class="control" placeholder="example@gmail.com" required>
      </div>
      <div class="form-group">
        <label for="memo">備註（可輸入 LINE ID 或其他需求）</label>
        <textarea id="memo" name="memo" class="control" rows="3" placeholder="選填"></textarea>
        <div class="reminder-box">檢測前請將車輛外觀清洗、內部物品移除 ; 檢測車輛同時會拍照 , 作為上架販售使用(檢測時間 1~1.5h)</div>
      </div>
      <div class="form-group-agree">
        <input type="checkbox" id="agree" name="agree" required disabled>
        <label for="agree">我已閱讀並同意<a href="javascript:void(0);" id="open-declaration">檢測聲明事項</a></label>
      </div>
      <button id="submit" type="submit" class="control" disabled>立即預約</button>
    </form>
  </div>

  <div id="modal" class="modal-overlay">
    <div class="modal-content">
      <h2 id="modal-title"></h2>
      <p id="modal-message"></p>
      <button id="modal-close" class="control">關閉</button>
    </div>
  </div>

  <div id="declaration-modal" class="modal-overlay">
    <div class="modal-content declaration">
      <h2 id="declaration-title">檢測聲明事項</h2>
      <div id="declaration-content">
        <ol>
            <li>因受檢測方式、設備之限制，故無法檢查引擎內部運轉狀況，包含內鏈、吃機油等內部之零件或現象。</li>
            <li>車輛檢測皆採目視檢查，變速箱、加力箱、屬於封閉式零件，無法檢視內部磨損程度。</li>
            <li>底盤零件因檢測無法舉升，底盤零件除避震器外，無法檢查耗損程度。</li>
            <li>48V輔助電瓶或電動車之電池健康度不在檢測範圍內。</li>
            <li>碳纖維或塑膠鈑件及製品不在檢測範圍內。</li>
            <li>車體外觀如有包膜則無法檢測外觀鈑件有無刮凹痕現象。</li>
            <li>非舉升檢查所能發現之結構損傷將不在檢測範圍內。</li>
            <li>檢測時需視情況拆飾板及門邊膠條檢查，因物品自然老化造成之損壞均不予以賠償。</li>
            <li>檢視敞篷車型視情況檢查開關功能是否異常，因物品自然老化造成損壞不予以賠償。</li>
            <li>天窗檢查時需作動測試，因電器類自然老化造成損壞均不予以賠償。</li>
            <li>業界目前尚無技術檢測車輛里程之正確性，檢測報告僅登錄儀表板燈下顯示之里程，不代表車輛正確之里程。</li>
            <li>車輛檢查皆以目視評估，並無拆卸引擎、變速箱、及車輛零組件「車輛檢測單」以標車酷車輛檢測師陳述檢查結果。</li>
            <li>本檢測報告僅提供車況予買賣雙方參考，不代表車輛售價能完整反映車況。</li>
            <li>本檢測報告僅對車輛檢測當時車況進行評估，不代表無異狀之部分在日後不會有故障或不良之情況。</li>
            <li>本檢測報告僅供買賣雙方參考，不作為法律訟訟之文件。</li>
        </ol>
      </div>
      <button id="declaration-close" class="control">我明白了</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
  <script>
    /* ===== Endpoints ===== */
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxKNqFkl3FqdskRQ_zUD3xvsfUPPuI5RT-5qDW242o3WedCHGNdNT3U-m6k8XT1nG8o/exec';
    const BRAND_JSON = 'https://sicarpeter.github.io/-/data/brands.json';
    const MODEL_JSON = 'https://sicarpeter.github.io/-/data/models.json';


/* ===== Local cache ===== */
const LS = {
  get(k, sec){ 
    try{ 
      const v = JSON.parse(localStorage.getItem(k) || 'null'); 
      if(!v) return null; 
      if(sec && (Date.now() - v.t)/1000 > sec) return null; 
      return v.v; 
    }catch{return null} 
  },
  set(k, v){ localStorage.setItem(k, JSON.stringify({t:Date.now(), v})) }
};

    
    /* ===== DOM ===== */
    const form = document.getElementById('form');
    const dateEl = document.getElementById('datepicker');
    const slotEl = document.getElementById('slot');
    const brandEl = document.getElementById('brand');
    const modelEl = document.getElementById('model');
    const yearEl = document.getElementById('year');
    const submitBtn = document.getElementById('submit');
    const agreeCheckbox = document.getElementById('agree');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalCloseBtn = document.getElementById('modal-close');
    const openDeclarationLink = document.getElementById('open-declaration');
    const declarationModal = document.getElementById('declaration-modal');
    const declarationCloseBtn = document.getElementById('declaration-close');
    
    let hasReadDeclaration = false;
    let picker; // ✅ 提升 picker 變數作用域

    /* ===== Slots 快取設定 ===== */
let slotsCache = {};
const SLOTS_CACHE_KEY = 'slotsCache';
const SLOTS_CACHE_TTL = 300; // 秒 (5分鐘)

    /* ===== Modal Logic ===== */
    function showModal(message, type) {
      modalTitle.textContent = '';
      modalTitle.className = '';
      modalMessage.textContent = message || '';
      if (type === 'success') {
        modalTitle.textContent = '預約成功！';
        modalTitle.classList.add('success');
      }
      if (type === 'error') {
        modalTitle.textContent = '操作失敗';
        modalTitle.classList.add('error');
      }
      modal.classList.add('show');
    }
    function hideModal() { modal.classList.remove('show'); }
    modalCloseBtn.addEventListener('click', hideModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });

    /* ===== 聲明事項 Modal ===== */
    openDeclarationLink.addEventListener('click', (e) => {
      e.preventDefault();
      declarationModal.classList.add('show');
    });
    declarationCloseBtn.addEventListener('click', () => {
      declarationModal.classList.remove('show');
      agreeCheckbox.disabled = false;
      hasReadDeclaration = true;
    });

    /* ===== Date Picker ===== */
const today = new Date();
const max = new Date(); 
max.setMonth(max.getMonth() + 2);

let closedDays = [];


// ✅ 初始化日期選擇器，但先 disabled
function initPicker() {
  picker = new Litepicker({
    element: dateEl,
    singleMode: true,
    lang: 'zh-TW',
    format: 'YYYY-MM-DD',
    minDate: today,
    maxDate: max,
    autoApply: true,
    mobileFriendly: true,
    lockDaysFilter: (date) => {
      const day = date.getDay();
      const dateStr = date.format('YYYY-MM-DD');
      return day === 0 || day === 1 || closedDays.includes(dateStr);
    },
  });
  picker.on('selected', (date) => {
    const d = date ? date.format('YYYY-MM-DD') : '';
    if (d) fetchSlots(d);
  });

  // 預設 disable，等資料載入完才啟用
  dateEl.value = '';
  dateEl.disabled = true;
  dateEl.placeholder = '載入中…';
}

// ✅ 載入關閉日期 & 初始化快取
async function fetchClosedDaysAndInit() {
  try {
    const res = await fetch(`${APPS_SCRIPT_URL}?action=closed-days`);
    const json = await res.json();
    if (json.success && Array.isArray(json.data)) {
      closedDays = json.data;
    }
  } catch (err) {
    console.error('Failed to fetch closed days:', err);
  }

  // 初始化 DatePicker
  initPicker();



  // 資料載完才啟用 DatePicker
  dateEl.disabled = false;
  dateEl.placeholder = '請先選擇日期';
}

/* ===== 頁面載入時，執行這些 ===== */
fetchClosedDaysAndInit();  // 日期 & 時段快取
initBrands();              // 廠牌 & 車款
initYear();                // 年份


    
    /* ===== 初始化：年份 ===== */
    function initYear() {
      const startYear = 2010;
      const endYear = new Date().getFullYear() + 1; // 動態取得今年+1
      yearEl.innerHTML = '<option value="">請選擇年份</option>';
      for (let i = endYear; i >= startYear; i--) {
        yearEl.appendChild(new Option(i, i));
      }
    }
   




    /* ===== 初始化：品牌 & 車款 ===== */
    async function initBrands(){
      brandEl.disabled = true; brandEl.innerHTML = '<option value="">載入中...</option>';
      const cached = LS.get('brands', 86400);
      if (cached) renderBrands(cached);
      try{
        const res = await fetch(BRAND_JSON, {cache:'force-cache'});
        const data = await res.json();
        let list = [];
        if (Array.isArray(data)) { list = data.map(x => typeof x === 'string' ? ({id:x, name:x}) : ({id:(x.id??x.value??x.code??x.name), name:(x.name??x.label??String(x.id??x.value??x.code??x))})); }
        else if (data && Array.isArray(data.brands)) { list = data.brands.map(x => typeof x === 'string' ? ({id:x, name:x}) : ({id:(x.id??x.value??x.code??x.name), name:(x.name??x.label??String(x.id??x.value??x.code??x))})); }
        else if (data && typeof data === 'object') { list = Object.keys(data).map(k => ({id:k, name:k})); }
        if (!list.length) throw new Error('brands.json 格式不符');
        LS.set('brands', list);
        renderBrands(list);
        const first = list[0]?.id;
        if (first) fetchModels(first, {silent:true});
      }catch(e){
        console.warn('load brands error', e);
        if (!cached){ brandEl.innerHTML = '<option value="">品牌載入失敗</option>'; brandEl.disabled = true; }
      }
    }
    brandEl.addEventListener('change', () => {
      const id = brandEl.value;
      if (!id){ modelEl.disabled = true; modelEl.innerHTML = '<option value="">請先選擇廠牌</option>'; return; }
      fetchModels(id);
    });
    async function fetchModels(brandId, {silent=false} = {}){
      const CK = 'models:' + brandId;
      const cached = LS.get(CK, 21600);
      if (cached) renderModels(cached);
      if (!silent){ modelEl.disabled = true; modelEl.innerHTML = '<option value="">載入中...</option>'; }
      try{
        const res = await fetch(MODEL_JSON, {cache:'force-cache'});
        const data = await res.json();
        let list = [];
        if (Array.isArray(data)) { list = data.filter(x => String(x.brand_id??x.brandId??x.BrandId) === String(brandId)).map(x => ({id:(x.id??x.value??x.code??x.name), name:(x.name??x.label??String(x.id))})); }
        else if (data && typeof data === 'object') {
          const byKey = data[String(brandId)] || data[brandEl.options[brandEl.selectedIndex].text] || null;
          if (Array.isArray(byKey)) { list = byKey.map(x => typeof x === 'string' ? ({id:x, name:x}) : ({id:(x.id??x.value??x.code??x.name), name:(x.name??x.label??String(x.id))})); }
        }
        if (!list.length) { modelEl.disabled = true; modelEl.innerHTML = '<option value="">此廠牌尚無車款</option>'; return; }
        LS.set(CK, list);
        renderModels(list);
      }catch(e){
        console.warn('load models error', e);
        if (!cached){ modelEl.disabled = true; modelEl.innerHTML = '<option value="">車款載入失敗</option>'; }
      }
    }
    function renderBrands(list){
      brandEl.innerHTML = '<option value="">請選擇廠牌</option>';
      list.forEach(b => brandEl.appendChild(new Option(String(b.name), String(b.id))));
      brandEl.disabled = false;
    }
    function renderModels(list){
      modelEl.innerHTML = '<option value="">請選擇車款</option>';
      list.forEach(m => modelEl.appendChild(new Option(String(m.name), String(m.id))));
      modelEl.disabled = false;
    }

/* ===== 日期正規化（修正時區問題） ===== */
function normalizeDate(dateStr) {
  const parts = String(dateStr).match(/^(\d{4})[^\d](\d{1,2})[^\d](\d{1,2})/);
  if (!parts) return String(dateStr); // 如果格式不符，直接回傳原字串
  
  const y = parseInt(parts[1], 10);
  const m = parseInt(parts[2], 10) - 1; // 月份是 0-indexed
  const d = parseInt(parts[3], 10);
  
  // 建立一個在本地時區正午 12 點的日期物件，確保不會因時區偏移而跨日
  const localD = new Date(y, m, d, 12, 0, 0); 
  
  const yyyy = localD.getFullYear();
  const mm = String(localD.getMonth() + 1).padStart(2, '0');
  const dd = String(localD.getDate()).padStart(2, '0');
  
  return `${yyyy}-${mm}-${dd}`;
}

/* ===== 依日期載入時段（單日 API + 短快取） ===== */
async function fetchSlots(dateStr) {
  const normalizedDate = normalizeDate(dateStr);

   // 顯示載入中
  slotEl.disabled = true;
  slotEl.innerHTML = '<option value="">載入中，請稍等…</option>';

  // 先檢查 localStorage 快取
  const CK = `slots:${normalizedDate}`;
  const cached = LS.get(CK, 300); // 5 分鐘快取
  if (cached) {
    console.log('[fetchSlots] 使用快取:', normalizedDate, cached);
    renderSlots(cached);
    return;
  }

  try {
    const res = await fetch(`${APPS_SCRIPT_URL}?action=slots&date=${encodeURIComponent(normalizedDate)}`);
    const json = await res.json();
    if (json.success && json.data) {
      const slots = json.data || {};
      LS.set(CK, slots);
      renderSlots(slots);
    } else {
      renderSlots({});
    }
  } catch (err) {
    console.error('fetchSlots error:', err);
   renderSlots({}, true); // 傳 true 表示錯誤
  }
}

/* ===== 渲染時段選單 ===== */
function renderSlots(slots, error = false) {
  slotEl.innerHTML = '';
  
  if (error) {
    slotEl.innerHTML = '<option value="">載入失敗，請稍後重試</option>';
    slotEl.disabled = true;
    return;
  }

  let hasValid = false;
  Object.entries(slots).forEach(([time, remaining]) => {
    if (remaining > 0) {
      const opt = new Option(`${time}（剩餘 ${remaining} 位）`, time);
      slotEl.appendChild(opt);
      hasValid = true;
    }
  });

  if (!hasValid) {
    slotEl.innerHTML = '<option value="">該日無可用時段</option>';
    slotEl.disabled = true;
  } else {
    slotEl.disabled = false;
  }
}



    /* ===== 啟用/禁用送出按鈕 ===== */
    agreeCheckbox.addEventListener('change', () => { submitBtn.disabled = !agreeCheckbox.checked; });

    /* ===== 表單驗證 ===== */
    const fieldNames = { item: '預約項目', datepicker: '日期', slot: '時段', brand: '廠牌', model: '車款', year: '年份', name: '姓名', phone: '手機號碼', email: '電子郵件' };
    function validateForm() {
      // 清除舊的錯誤提示
      document.querySelectorAll('.control.is-invalid').forEach(el => el.classList.remove('is-invalid'));
      
      const requiredIds = ['item','datepicker','slot','brand','model','year','name','phone','email'];
      for (const id of requiredIds) {
        const el = document.getElementById(id);
        if (!el || !el.value) {
          return { id, message: `請選擇或填寫「${fieldNames[id]}」。` };
        }
      }
      if (!agreeCheckbox.checked) {
        return { id: 'agree', message: '請先閱讀並同意檢測聲明事項。' };
      }
      return null;
    }

/* ===== 送出 ===== */
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const validationError = validateForm();
  if (validationError) {
    showModal(validationError.message, 'error');
    const errorEl = document.getElementById(validationError.id);
    if (errorEl) {
      errorEl.classList.add('is-invalid');
      errorEl.focus({ preventScroll: true });
      errorEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    return;
  }

  submitBtn.disabled = true; 
  submitBtn.textContent = '預約中...';

  try {
    // ✅ 先取得 reCAPTCHA token
    const token = await grecaptcha.execute('6LcSotkrAAAAAN17wjVrzK3M0XmRG2HTiaovvTUD', { action: 'reserve' });
    const params = new URLSearchParams(new FormData(form));
    params.set('action','reserve');
    params.set('recaptchaToken', token); // 把 token 帶上去

    const res  = await fetch(APPS_SCRIPT_URL, {
      method:'POST',
      body: params,
      mode:'cors',
    });

    const ct = res.headers.get('content-type') || '';
    const data = ct.includes('application/json') ? await res.json() : { success:false, message:'伺服器未回 JSON' };

    if (data.success) {
      showModal(data.message || '我們已收到您的預約，稍後將以 Email 確認。','success');
      form.reset();
      if (picker) picker.clearSelection();
      agreeCheckbox.checked = false;
      agreeCheckbox.disabled = true;
      hasReadDeclaration = false;
      submitBtn.disabled = true;
      slotEl.innerHTML = `<option value="">請先選擇日期</option>`; 
      slotEl.disabled = true;
      modelEl.innerHTML = `<option value="">請先選擇廠牌</option>`; 
      modelEl.disabled = true;

// ✅ 送出成功後清掉所有 slots 快取
Object.keys(localStorage).forEach(k => {
  if (k.startsWith('slots:')) {
    localStorage.removeItem(k);
  }
});

// 使用者剛選的日期，強制重新抓最新時段
if (dateEl.value) {
  fetchSlots(dateEl.value);


    } else {
      throw new Error(data.message || '預約失敗');
    }

  } catch (err) {
    showModal(err.message || '連線失敗，請稍後再試。','error');
    // ✅ 修改：失敗時才恢復按鈕
    submitBtn.disabled = !agreeCheckbox.checked;
  } finally {
    submitBtn.textContent = '立即預約';
  }
});

    // 避免 iOS 雙擊放大
    let lastTouch = 0;
    document.addEventListener('touchend', (e)=>{
      const now = Date.now();
      if (now - lastTouch <= 300) e.preventDefault();
      lastTouch = now;
    }, {passive:false});
  </script>
</body>
</html>

