/** ===== 標車酷 預約 API（Apps Script 後端，完整覆蓋版） =====
 * 前端：GitHub Pages（fetch 呼叫）
 * 後端：Apps Script Web App（Deploy：Anyone）
 * Endpoints:
 *  - GET  ?action=health                -> {"success":true}
 *  - GET  ?action=slots&date=YYYY-MM-DD -> {"success":true,"data":{"10:00":2,...}}
 *  - GET  ?cancelCode=...               -> 取消結果 HTML
 *  - POST (JSON 或 x-www-form-urlencoded; action=reserve 可選) -> 建立預約
 */

const TZ = Session.getScriptTimeZone() || 'Asia/Taipei';

/* ------------ 小工具：JSON 輸出 ------------ */
function json(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

/* ------------ 入口：GET ------------ */
function doGet(e) {
  try {
    // 取消預約頁（HTML）
    if (e && e.parameter && e.parameter.cancelCode) {
      const result = cancelAppointment(e.parameter.cancelCode);
      const color = result.success ? '#0ba360' : '#e53935';
      const html = `
        <html>
          <head>
            <meta charset="UTF-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <title>取消預約</title>
            <style>
              body { font-family:'Noto Sans TC',sans-serif; background:#0f172a; color:#e2e8f0; margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; }
              .card { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:24px; max-width:600px; width:100%; box-shadow:0 10px 30px rgba(0,0,0,.35); }
              h1 { margin:0 0 12px; font-size:20px; color:#a7f3d0; }
              p.status { margin:0; font-weight:700; color:${color}; }
              a { color:#93c5fd; }
            </style>
          </head>
          <body>
            <div class="card">
              <h1>取消預約結果</h1>
              <p class="status">${escapeHtml(result.message)}</p>
              <p style="margin-top:16px;">回到 <a href="https://sicarpeter.github.io/-/">預約頁面</a></p>
            </div>
          </body>
        </html>`;
      return HtmlService.createHtmlOutput(html).setTitle('取消預約');
    }

    const action = (e && e.parameter && String(e.parameter.action).toLowerCase()) || 'health';

    if (action === 'health') {
      return json({ success: true, ts: new Date().toISOString() });
    }

    if (action === 'slots') {
      const dateStr = e && e.parameter && e.parameter.date ? String(e.parameter.date) : '';
      if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
        return json({ success: false, message: '缺少或錯誤的 date（YYYY-MM-DD）' });
      }
      const slots = getAvailableSlots(dateStr); // { "10:00": 3, ... }
      return json({ success: true, data: slots });
    }

    return json({ success: false, message: 'Unknown action' });

  } catch (err) {
    return json({ success: false, message: 'Server error', detail: String(err) });
  }
}

/* ------------ 入口：POST（支援 JSON 或 x-www-form-urlencoded） ------------ */
function doPost(e) {
  try {
    let body = {};

    if (e && e.postData && e.postData.contents) {
      // 先嘗試 JSON
      try {
        body = JSON.parse(e.postData.contents);
      } catch (_) {
        // 再嘗試 x-www-form-urlencoded（從 e.parameter 取）
        if (e.parameter) body = e.parameter;
      }
    }

    // 支援 action=reserve（可選），沒有也照常處理
    const action = (body.action || '').toString().toLowerCase();
    if (action && action !== 'reserve') {
      return json({ success: false, message: '不支援的 action' });
    }

    // 驗證必填（加入 brand / model）
    const required = ['item','date','time','name','phone','email','brand','model'];
    for (var i = 0; i < required.length; i++) {
      const k = required[i];
      if (!body[k]) return json({ success: false, message: `缺少欄位：${k}` });
    }

    // 手機格式（台灣）
    const phoneRegex = /^(09|\+?8869)\d{8}$/;
    if (!phoneRegex.test(String(body.phone))) {
      return json({ success: false, message: '請輸入有效的台灣手機號碼格式。' });
    }

    // 建立預約（寫表＋日曆＋寄信）
    const result = createReservation({
      item : String(body.item),
      date : String(body.date),
      time : String(body.time),
      name : String(body.name),
      phone: String(body.phone),
      email: String(body.email),
      memo : body.memo ? String(body.memo) : '',
      brand: String(body.brand),
      model: String(body.model)
    });

    return json(result);

  } catch (err) {
    return json({ success: false, message: '預約失敗，請稍後再試或聯繫客服。', detail: String(err) });
  }
}

/* ------------ 建立預約（核心流程；依欄名寫入＋快取失效） ------------ */
function createReservation(formData) {
  const cancelCode = Utilities.getUuid();

  const ss = getOrCreateSpreadsheet();
  const sheet = ss.getSheets()[0];

  // 取得與補齊表頭
  let headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const needed = ['預約時間','姓名','電子郵件','聯絡電話','備註','填單時間','取消碼','預約狀態','預約項目','廠牌','車款'];
  let appended = false;
  needed.forEach(name => {
    if (headers.indexOf(name) === -1) { headers.push(name); appended = true; }
  });
  if (appended) sheet.getRange(1, 1, 1, headers.length).setValues([headers]);

  function idx(name){ const i = headers.indexOf(name); if (i === -1) throw new Error('缺少欄位：'+name); return i; }

  // 準備資料列
  const start = new Date(`${formData.date}T${formData.time}:00`);
  const row = new Array(headers.length).fill('');
  row[idx('預約時間')] = start;
  row[idx('姓名')]     = formData.name;
  row[idx('電子郵件')] = formData.email;
  row[idx('聯絡電話')] = formData.phone;
  row[idx('備註')]     = formData.memo || '';
  row[idx('填單時間')] = new Date();
  row[idx('取消碼')]   = cancelCode;
  row[idx('預約狀態')] = '未取消';
  row[idx('預約項目')] = formData.item;
  row[idx('廠牌')]     = formData.brand;
  row[idx('車款')]     = formData.model;

  sheet.appendRow(row);

  // 建日曆（1hr）
  const event = createCalendarEvent(formData);

  // 取消連結
  let scriptUrl = '';
  try { scriptUrl = ScriptApp.getService().getUrl(); } catch (_) {}
  const cancelLink = scriptUrl ? `${scriptUrl}?cancelCode=${encodeURIComponent(cancelCode)}` : '';

  // 寄信
  sendConfirmationEmails(formData, cancelLink, event ? event.getId() : '');

  // 讓該日的時段快取失效（前端重查會拿到最新餘量）
  try { CacheService.getScriptCache().remove('slots:' + formData.date); } catch(_) {}

  return { success: true, message: '預約成功！確認信已發送至您的電子郵件。', cancelLink };
}

/* ------------ 可預約時段計算（含 60 秒快取） ------------ */
function getAvailableSlots(dateStr) {
  const ALL = ['10:00','11:00','14:00','15:00'];
  const CAP = 3;

  const cache = CacheService.getScriptCache();
  const key = 'slots:' + dateStr;
  const hit = cache.get(key);
  if (hit) return JSON.parse(hit);

  const counts = Object.fromEntries(ALL.map(t => [t, 0]));
  const id = PropertiesService.getScriptProperties().getProperty('RESERVATION_SPREADSHEET_ID');

  if (id) {
    const sh = SpreadsheetApp.openById(id).getSheets()[0];
    const last = sh.getLastRow();
    if (last >= 2) {
      const rng = sh.getDataRange().getValues(); // 讀整表一次，最省往返
      const headers = rng[0] || [];
      const timeCol  = headers.indexOf('預約時間');
      const statusCol= headers.indexOf('預約狀態');
      for (let r=1; r<rng.length; r++){
        const row = rng[r];
        const status = row[statusCol];
        const dt = row[timeCol];
        if (status === '已取消') continue;
        if (dt instanceof Date && Utilities.formatDate(dt, TZ, 'yyyy-MM-dd') === dateStr) {
          const t = Utilities.formatDate(dt, TZ, 'HH:mm');
          if (counts[t] != null) counts[t]++;
        }
      }
    }
  }

  const out = {};
  for (const t of ALL){
    const remain = CAP - (counts[t]||0);
    if (remain > 0) out[t] = remain;
  }
  cache.put(key, JSON.stringify(out), 60); // 快取 60 秒
  return out;
}

/* ------------ 取消預約（供 ?cancelCode= 使用） ------------ */
function cancelAppointment(cancelCode) {
  try {
    const spreadsheetId = PropertiesService.getScriptProperties().getProperty('RESERVATION_SPREADSHEET_ID');
    if (!spreadsheetId) return { success: false, message: '系統錯誤：無法找到預約記錄表。' };

    const ss = SpreadsheetApp.openById(spreadsheetId);
    const sheet = ss.getSheets()[0];
    const data = sheet.getDataRange().getValues();
    const headers = data[0] || [];
    const cancelIdx = headers.indexOf('取消碼');
    const statusIdx = headers.indexOf('預約狀態');
    const nameIdx   = headers.indexOf('姓名');
    const timeIdx   = headers.indexOf('預約時間');
    const itemIdx   = headers.indexOf('預約項目');

    if (cancelIdx === -1 || statusIdx === -1) {
      return { success: false, message: '試算表格式不符，請聯繫客服。' };
    }

    for (let r = 1; r < data.length; r++) {
      const row = data[r];
      if (String(row[cancelIdx]) === String(cancelCode)) {
        if (String(row[statusIdx]) === '已取消') {
          return { success: false, message: '此預約已取消。' };
        }
        // 標記取消
        sheet.getRange(r + 1, statusIdx + 1).setValue('已取消');

        // 嘗試刪日曆
        try {
          const cal = CalendarApp.getDefaultCalendar();
          const start = (row[timeIdx] instanceof Date) ? row[timeIdx] : new Date(row[timeIdx]);
          const end   = new Date(start.getTime() + 60 * 60 * 1000);
          const title = `【${row[itemIdx] || '車輛檢測'}預約】：${row[nameIdx] || ''}`;
          const events = cal.getEvents(start, end);
          for (let i = 0; i < events.length; i++) {
            if (events[i].getTitle() === title) { events[i].deleteEvent(); break; }
          }
        } catch (_) {}

        // 通知商家
        const when = (row[timeIdx] instanceof Date) ? row[timeIdx] : new Date(row[timeIdx]);
        sendCancellationEmailToMerchant({
          name: row[nameIdx] || '',
          item: row[itemIdx] || '車輛檢測',
          date: Utilities.formatDate(when, TZ, 'yyyy-MM-dd'),
          time: Utilities.formatDate(when, TZ, 'HH:mm')
        });

        // 讓該日時段快取失效
        try { CacheService.getScriptCache().remove('slots:' + Utilities.formatDate(when, TZ, 'yyyy-MM-dd')); } catch(_) {}

        return { success: true, message: '預約已成功取消。' };
      }
    }
    return { success: false, message: '取消碼無效或預約不存在。' };

  } catch (err) {
    return { success: false, message: '取消失敗，請稍後再試或聯繫客服。' };
  }
}

/* ------------ 試算表（建立/取得） ------------ */
function getOrCreateSpreadsheet() {
  const key = 'RESERVATION_SPREADSHEET_ID';
  const id  = PropertiesService.getScriptProperties().getProperty(key);
  if (id) return SpreadsheetApp.openById(id);

  const ss = SpreadsheetApp.create('【標車酷-檢測預約紀錄】');
  const sheet = ss.getSheets()[0];
  sheet.appendRow([
    '預約時間','姓名','電子郵件','聯絡電話','備註','填單時間',
    '取消碼','預約狀態','預約項目','廠牌','車款' // 預設含廠牌/車款
  ]);
  PropertiesService.getScriptProperties().setProperty(key, ss.getId());
  return ss;
}

/* ------------ 建立日曆事件（1hr） ------------ */
function createCalendarEvent(formData) {
  const cal   = CalendarApp.getDefaultCalendar();
  const start = new Date(`${formData.date}T${formData.time}:00`);
  const end   = new Date(start.getTime() + 60 * 60 * 1000);
  const title = `【${formData.item}預約】：${formData.name}`;
  const desc  = [
    `客戶姓名: ${formData.name}`,
    `手機號碼: ${formData.phone}`,
    `Email: ${formData.email}`,
    `備註: ${formData.memo || '無'}`,
    `預約項目: ${formData.item}`,
    `廠牌: ${formData.brand}`,
    `車款: ${formData.model}`
  ].join('\n');

  return cal.createEvent(title, start, end, {
    description: desc,
    guests: formData.email,
    sendInvites: true
  });
}

/* ------------ 寄信：預約成功（包含廠牌／車款） ------------ */
function sendConfirmationEmails(formData, cancelLink, eventId) {
  const customerEmail = formData.email;
  const merchantEmail = 'peter.kuo@sicar.com.tw, it@sicar.com.tw';

  const cs = `標車酷 - 您的${formData.item}預約已成功！`;
  const cb = [
    `親愛的 ${formData.name} 您好，`,
    ``,
    `您的${formData.item}預約已成功建立，詳細資訊如下：`,
    `- 預約項目：${formData.item}`,
    `- 預約日期：${formData.date}`,
    `- 預約時段：${formData.time}`,
    `- 廠牌：${formData.brand}`,
    `- 車款：${formData.model}`,
    `- 您的姓名：${formData.name}`,
    `- 您的手機：${formData.phone}`,
    `- 您的電子郵件：${formData.email}`,
    `- 備註：${formData.memo || '無'}`,
    ``,
    cancelLink ? `如需取消預約，請點擊：${cancelLink}` : '',
    ``,
    `感謝您的預約！`
  ].join('\n');

  const ms = `【新預約通知】${formData.item}預約：${formData.name}`;
  const mb = [
    `您好，`,
    ``,
    `有一筆新的${formData.item}預約：`,
    `- 客戶姓名：${formData.name}`,
    `- 預約日期：${formData.date}`,
    `- 預約時段：${formData.time}`,
    `- 廠牌：${formData.brand}`,
    `- 車款：${formData.model}`,
    `- 手機號碼：${formData.phone}`,
    `- 電子郵件：${formData.email}`,
    `- 備註：${formData.memo || '無'}`,
    cancelLink ? `- 取消連結：${cancelLink}` : ''
  ].join('\n');

  MailApp.sendEmail(customerEmail, cs, cb);
  MailApp.sendEmail(merchantEmail, ms, mb);
}

/* ------------ 寄信：取消通知（商家） ------------ */
function sendCancellationEmailToMerchant(formData) {
  const merchantEmail = 'peter.kuo@sicar.com.tw, it@sicar.com.tw';
  const subj = `【預約取消通知】${formData.item}預約：${formData.name}`;
  const body = [
    `您好，`,
    ``,
    `以下預約已被取消：`,
    `- 客戶姓名：${formData.name}`,
    `- 預約項目：${formData.item}`,
    `- 預約日期：${formData.date}`,
    `- 預約時段：${formData.time}`,
    ``,
    `此為系統自動發送，請勿直接回覆。`
  ].join('\n');

  MailApp.sendEmail(merchantEmail, subj, body);
}

/* ------------ 字串轉義 ------------ */
function escapeHtml(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}
